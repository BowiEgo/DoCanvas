!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).XCanvas=e()}(this,function(){"use strict";function F(t){return"function"==typeof t}var _=Object.freeze({}),w=Object.freeze([]),X=/^on[^a-z]/,O=function(t){return X.test(t)},C=function(t){return"number"==typeof t},a=function(t){return"auto"===t},m=function(t){if("string"==typeof t)return t.match("%")},S=function(t){t=parseInt(t.replace("%",""));return isNaN(t)||t<0?0:t/100},g=Array.isArray,l=function(t){return"string"==typeof t},s=function(t){return null!==t&&"object"==typeof t};function x(t){return.5+t<<0}function o(t,e){if(t)for(var n=t,i=!1,r=function(){i=!0};n.parent&&(e(n.parent,r),!i);)n=n.parent}var f=function(){try{return Boolean(wx.getSystemInfoSync)}catch(t){return!1}}();function h(t){if(g(t)){for(var e={},n=0;n<t.length;n++){var i=t[n],r=(l(i)?function(t){var e={};return t.replace(Y,"").split(N).forEach(function(t){t&&1<(t=t.split(D)).length&&(e[t[0].trim()]=t[1].trim())}),e}:h)(i);if(r)for(var o in r)e[o]=r[o]}return e}return l(t)||s(t)?t:void 0}var N=/;(?![^(]*\))/g,D=/:([^]+)/,Y=/\/\*.*?\*\//gs;function c(t){var e="";if(l(t))e=t;else if(g(t))for(var n=0;n<t.length;n++){var i=c(t[n]);i&&(e+=i+" ")}else if(s(t))for(var r in t)t[r]&&(e+=r+" ");return e.trim()}var U=Symbol.for("v-fgt"),V=Symbol.for("v-cmt");function d(t){return t&&!0===t.__v_isVNode}function L(t,e,n){var i,r,o;return void 0===e&&(e=null),void 0===n&&(n=null),console.log("createVNode",t,e,n),d(t)?(o=y(t,e),console.log("cloned",o),n&&(i=o,r=n,console.log("normalizeChildren",i,r),null==r?r=null:g(r)||"object"==typeof r||F(r)||(r=[u(r)]),i.children=r),console.log("children",n),o):(e&&(i=e.class,r=e.style,i&&!l(i)&&(e.class=c(i)),s(r))&&(e.style=h(r)),o=t,void 0===(t=e)&&(t=null),void 0===(e=n)&&(e=null),console.log("createBaseVNode",o,t,e),{__v_isVNode:!0,__v_skip:!0,type:o,props:t,children:e,component:null,el:null,staticCount:0,appContext:null,ctx:null})}function y(t,e){var n,i;return t&&"object"!=typeof t?(console.log("cloneVNode",t),t):(n=t.props,i=t.children,e=e?function(){for(var t=arguments,e=[],n=0;n<arguments.length;n++)e[n]=t[n];for(var i={},r=0;r<e.length;r++){var o,l,s,d=e[r];for(o in d)"class"===o?i.class!==d.class&&(i.class=c([i.class,d.class])):"style"===o?i.style=h([i.style,d.style]):O(o)?(l=i[o],!(s=d[o])||l===s||g(l)&&l.includes(s)||(i[o]=l?[].concat(l,s):s)):""!==o&&(i[o]=d[o])}return i}(n||{},e):n,{__v_isVNode:!0,type:t.type,props:e,children:g(i)?i.map(r):i,staticCount:t.staticCount,appContext:t.appContext,component:t.component,el:t.el,ctx:t.ctx})}function r(t){console.log("deepCloneVNode",t);var e=y(t);return g(t.children)&&(e.children=t.children.map(r)),e}function u(t){return L("Text",null,t=void 0===t?" ":t)}function b(t){return console.log("normalizeVNode",t),null==t||"boolean"==typeof t?L(V):g(t)?L(U,null,t.slice()):"object"==typeof t?y(t):u(String(t))}var j=0;var v=function(){return(v=Object.assign||function(t){for(var e,n=arguments,i=1,r=arguments.length;i<r;i++)for(var o in e=n[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};var T=[],n=[],i=null,p=0,z=100;function K(t){if(n.length){var e=function(t,e,n){if(n||2===arguments.length)for(var i,r=0,o=e.length;r<o;r++)!i&&r in e||((i=i||Array.prototype.slice.call(e,0,r))[r]=e[r]);return t.concat(i||Array.prototype.slice.call(e))}([],new Set(n),!0);if(n.length=0,i)i.push.apply(i,e);else{for(i=e,t=t||new Map,i.sort(function(t,e){return W(t)-W(e)}),p=0;p<i.length;p++)B(t,i[p])||i[p]();i=null,p=0}}}var W=function(t){return null==t.id?1/0:t.id};function B(t,e){if(t.has(e)){var n=t.get(e);if(z<n)return 1;t.set(e,n+1)}else t.set(e,1)}var t={BLOCK:"block",INLINE_BLOCK:"inline-block",INLINE:"inline",FLEX:"flex",NONE:"none"},e={AUTO:"auto",OUTER:"100%"},R={ROW:"row",COLUMN:"column"},I={DISPLAY:t,WIDTH:e,POSITION:{ABSOLUTE:"absolute",FIXED:"fixed",RELATIVE:"relative",STATIC:"static"},TEXT_ALIGN:{LEFT:"left",RIGHT:"right",CENTER:"center"},FLEX_DIRECTION:R,DEFAULT_STYLES:{display:t.BLOCK,fontSize:14,fontWeight:400,fontFamily:"sans-serif",color:"#000",paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginTop:0,marginBottom:0,marginLeft:0,marginRight:0,height:e.AUTO,borderRadius:0,borderColor:"#000",lineCap:"square",flexDirection:R.ROW,verticalAlign:"middle",textAlign:"left",justifyContent:"flex-start",alignItems:"flex-start",alignSelf:"auto",whiteSpace:"normal",zIndex:1,visible:!0,position:"static"}};function E(t){return t&&!0===t.__v_isTreeNode}function G(t){(e=t).parent&&e.parent.styles.display===I.DISPLAY.FLEX&&(e.styles.flex?"column"===e.parent.styles.flexDirection&&C(e.styles.flex)?e.styles.height=0:"row"===e.parent.styles.flexDirection&&C(e.styles.flex)&&(e.styles.width=0):C(e.styles.height)||C(e.styles.width)||(e.styles.flex=1));var e=t,e=(e.styles.width||(e.styles.display!==I.DISPLAY.INLINE_BLOCK&&e.styles.display!==I.DISPLAY.INLINE&&e.isInFlow()?e.styles.display===I.DISPLAY.BLOCK||e.styles.display===I.DISPLAY.FLEX?e.styles.width=I.WIDTH.OUTER:e.styles.width=0:e.styles.width=I.WIDTH.AUTO),m(e.styles.width)&&e.parent&&a(e.parent.styles.width)&&(e.styles.width=I.WIDTH.AUTO),m(e.styles.height)&&e.parent&&a(e.parent.styles.height)&&(e.styles.height=I.WIDTH.AUTO),t),n=(s=e.styles).borderWidth,i=s.borderLeftWidth,r=s.borderRightWidth,o=s.borderBottomWidth,l=s.borderTopWidth,s=s.borderRadius,r=(n||(e.styles.borderWidth=0,n=0),Array.isArray(n)?(e.styles.borderTopWidth=n[0],e.styles.borderRightWidth=n[1],e.styles.borderBottomWidth=n[2],e.styles.borderLeftWidth=n[3]):(i||(e.styles.borderLeftWidth=n),r||(e.styles.borderRightWidth=n),o||(e.styles.borderBottomWidth=n),l||(e.styles.borderTopWidth=n)),s&&(e.styles.overflow="hidden"),(i=t).styles.fontSize&&!i.styles.lineHeight&&(i.styles.lineHeight=1.4*i.styles.fontSize),t);r.styles.padding&&(C(r.styles.padding)?(r.styles.paddingLeft=r.styles.padding,r.styles.paddingBottom=r.styles.padding,r.styles.paddingRight=r.styles.padding,r.styles.paddingTop=r.styles.padding):Array.isArray(r.styles.padding)&&(2===r.styles.padding.length?(r.styles.paddingLeft=r.styles.paddingRight=r.styles.padding[1],r.styles.paddingBottom=r.styles.paddingTop=r.styles.padding[0]):4===r.styles.padding.length&&(r.styles.paddingLeft=r.styles.padding[3],r.styles.paddingBottom=r.styles.padding[2],r.styles.paddingRight=r.styles.padding[1],r.styles.paddingTop=r.styles.padding[0]))),C(r.styles.margin)?(r.styles.marginLeft=r.styles.margin,r.styles.marginBottom=r.styles.margin,r.styles.marginRight=r.styles.margin,r.styles.marginTop=r.styles.margin):Array.isArray(r.styles.margin)&&(2===r.styles.margin.length?(r.styles.marginLeft=r.styles.marginRight=r.styles.margin[1],r.styles.marginBottom=r.styles.marginTop=r.styles.margin[0]):4===r.styles.margin.length&&(r.styles.marginLeft=r.styles.margin[3],r.styles.marginBottom=r.styles.margin[2],r.styles.marginRight=r.styles.margin[1],r.styles.marginTop=r.styles.margin[0]))}var M=0;(t={})[I.FLEX_DIRECTION.ROW]={width:"width",contentWidth:"contentWidth",x:"x",y:"y",contentX:"contentX",height:"height",contentHeight:"contentHeight"},t[I.FLEX_DIRECTION.COLUMN]={width:"height",contentWidth:"contentHeight",x:"y",y:"x",contentX:"contentY",height:"width",contentHeight:"contentWidth"};var A,q=t;function J(r){return function(t,e,n){void 0===e&&(e={}),console.log("createElement",t,e,n);var d,i={__v_isTreeNode:!0,_children:n=void 0===(n=n)?[]:n,parent:null,root:null,prev:null,next:null,get children(){return this._children},_setParent:function(t){console.log("_setParent",this,t),this.parent=t},_setSibling:function(t,e){console.log("_setSibling",t,e),this.prev=t,this.next=e},hasChildren:function(){return!(!Array.isArray(this._children)||!this._children.length)},appendChild:function(t){if(console.log("TreeNode-Append-Child---------------"),!E(t))throw Error("Unknown treeNode type");var e=this._children[this._children.length-1]||null;e&&E(e)&&e._setSibling(e.prev,t),Array.isArray(this._children)&&this._children.push(t),t._setParent(this),t._setSibling(e,null)},prependChild:function(t){if(!E(t))throw Error("Unknown treeNode type")},removeChild:function(t){if(!E(t))throw Error("Unknown treeNode type")},append:function(){},prepend:function(){},remove:function(){}},p=v(v({__v_isElement:!0,type:t,options:e,styles:{},renderStyles:{},debugColor:null,x:0,y:0,contentX:0,contentY:0,left:0,top:0,height:0,width:0,visible:!0,container:null,layer:r},i),{_initStyles:function(){console.log("_initStyle",p),p.styles=Object.assign({},p._getDefaultStyles(),p._getParentStyles(),p.options.style||{}),console.log("_initStyles-00000000",p.styles),p._completeStyles(),p._initRenderStyles(),console.log("_initStyles",p.styles,p.renderStyles)},_initRenderStyles:function(){var e,t=v({},p.styles),n=p.getContainerLayout().contentWidth,i=p.getContainerLayout().contentHeight;a(t.width)?t.paddingWidth=0:m(t.width)?t.paddingWidth=S(t.width)*n-t.marginLeft-t.marginRight:t.paddingWidth=t.width,a(t.height)?t.paddingHeight=0:m(t.height)?t.paddingHeight=S(t.height)*i-t.marginTop-t.marginBottom:t.paddingHeight=t.height,t.paddingWidth||(t.paddingWidth=0),t.paddingHeight||(t.paddingHeight=0),t.contentWidth=t.paddingWidth-t.paddingLeft-t.paddingRight,t.contentHeight=t.paddingHeight-t.paddingTop-t.paddingBottom,t.width=t.paddingWidth+t.marginLeft+t.marginRight+p._getTotalBorderWidth(t),t.height=t.paddingHeight+t.marginTop+t.marginBottom+p._getTotalBorderHeight(t),p.renderStyles=t,p._InFlexBox()?p._bindFlexBox():p.isInFlow()||(p.relativeTo=(n=p).isInFlow()?n.parent:"fixed"===n.renderStyles.position?n.root:(e=null,o(n,function(t){"static"!==t.renderStyles.position&&(e=e||t)}),e=e||n.root))},_getParentStyles:function(t){void 0===t&&(t={alignSelf:"auto"});var e,n=p.parent&&p.parent.renderStyles||{},i=n.textAlign,r=n.fontSize,o=n.color,l=n.fontFamily,s=n.alignItems,n=n.visible,n=void 0===n||n;return console.log("_getParentStyles",p.parent),p.parent?(console.log("_getParentStyles-renderStyles",p.parent.renderStyles),e={},i&&(e.textAlign=i),r&&(e.fontSize=r),o&&(e.color=o),l&&(e.fontFamily=l),s&&!t.alignSelf&&(e.alignSelf=s),e.visible=n,e):{}},_getDefaultStyles:function(){return I.DEFAULT_STYLES},_completeStyles:function(){G(p)},_getChildren:function(){return g(this.children)?this.children:[]},_getChildrenInFlow:function(){return p._getChildren().filter(function(t){return t.isInFlow()})},_reflow:function(){},_initWidthHeight:function(){console.log("_initWidthHeight------------");var t=p.styles,e=t.width,n=t.height,i=t.display;t.flex,t.marginLeft,t.marginRight,t.marginTop,t.marginBottom,(a(e)||a(n))&&(t=p._measureLayout(),a(e)&&(p.renderStyles.contentWidth=x(t.width)),a(n))&&(p.renderStyles.contentHeight=x(t.height)),p._refreshLayoutWithContent(),p._InFlexBox()?p.line.refreshWidthHeight(p):i===I.DISPLAY.INLINE_BLOCK&&p._bindLine()},_initPosition:function(){var t,e,n,i,r,o,l,s,d,a=p.getContainerLayout().contentX,h=p.renderStyles,g=h.paddingLeft,c=h.paddingTop,y=h.borderLeftWidth,u=h.borderTopWidth,f=h.marginLeft,h=h.marginTop;p.isInFlow()?p._InFlexBox()||p.renderStyles.display===I.DISPLAY.INLINE_BLOCK?p.line.refreshElementPosition(p):(p.x=a,p.y=p.getPrevLayout().y+p.getPrevLayout().height):(t=(a=p.getContainerLayout(p.relativeTo)).contentX,e=a.contentY,n=a.contentWidth,a=a.contentHeight,i=(d=p.renderStyles).top,r=d.bottom,o=d.right,l=d.left,s=d.width,d=d.height,m(i)&&(i=S(i)*a),m(r)&&(r=S(r)*a),m(l)&&(l=S(l)*n),m(o)&&(o=S(o)*n),C(i)?p.y=e+i:C(r)&&(p.y=e+a-r-d),C(l)?p.x=t+l:C(o)&&(p.x=t+n-o-s)),p.x=x(p.x),p.y=x(p.y),p.contentX=p.x+g+y+f,p.contentY=p.y+c+u+h},_InFlexBox:function(){return!!p.isInFlow()&&!!p.parent&&(!(!p.parent||p.parent.renderStyles.display!==I.DISPLAY.FLEX)||void 0)},_refreshLayoutWithContent:function(){p.renderStyles.height=x(p.renderStyles.contentHeight+p.renderStyles.paddingTop+p.renderStyles.paddingBottom+p.renderStyles.marginTop+p.renderStyles.marginBottom+p._getTotalBorderHeight()),p.renderStyles.width=x(p.renderStyles.contentWidth+p.renderStyles.paddingLeft+p.renderStyles.paddingRight+p.renderStyles.marginLeft+p.renderStyles.marginRight+p._getTotalBorderWidth()),p.renderStyles.paddingWidth=x(p.renderStyles.contentWidth+p.renderStyles.paddingLeft+p.renderStyles.paddingRight),p.renderStyles.paddingHeight=x(p.renderStyles.contentHeight+p.renderStyles.paddingTop+p.renderStyles.paddingBottom)},_refreshContentWithLayout:function(){p.renderStyles.contentHeight=p.renderStyles.height-p.renderStyles.paddingTop-p.renderStyles.paddingBottom-p.renderStyles.marginTop-p.renderStyles.marginBottom-p._getTotalBorderHeight(),p.renderStyles.contentWidth=p.renderStyles.width-p.renderStyles.paddingLeft-p.renderStyles.paddingRight-p.renderStyles.marginLeft-p.renderStyles.marginRight-p._getTotalBorderWidth(),p.renderStyles.paddingWidth=x(p.renderStyles.contentWidth+p.renderStyles.paddingLeft+p.renderStyles.paddingRight),p.renderStyles.paddingHeight=x(p.renderStyles.contentHeight+p.renderStyles.paddingTop+p.renderStyles.paddingBottom)},_getTotalBorderWidth:function(t){return(t=void 0===t?p.renderStyles:t).borderLeftWidth+t.borderRightWidth},_getTotalBorderHeight:function(t){return(t=void 0===t?p.renderStyles:t).borderTopWidth+t.borderBottomWidth},_bindLine:function(){var n;p.prev&&p.prev.line&&p.prev.line.canIEnter(p)?p.prev.line.add(p):(n={width:0,height:0,contentWidth:0,x:0,y:0,right:0,doorClosed:!1,outerWidth:0,container:null,elements:[],start:null,end:null,offsetX:0,id:++M,_initHeight:function(t){n.height=t.parent&&t.parent.context.renderStyles.lineHeight||0},_initLayout:function(t){n.right=t.getContainerLayout().contentX||0,n.x=t.getContainerLayout().contentX||0,n.y=n._getPrevLine(t).y},_getOffsetY:function(t){return"bottom"===t.renderStyles.verticalAlign?n.height-t.renderStyles.height:"middle"===t.renderStyles.verticalAlign?(n.height-t.renderStyles.height)/2:0},_refreshWidthHeight:function(t){t.renderStyles.height>n.height&&(n.height=t.renderStyles.height),n.width+=t.renderStyles.width},_closeLine:function(){n.end=n.elements[n.elements.length-1],n._refreshXAlign()},_getPrevLine:function(t){var e;return t.prev?(e=t.prev.context.line)?{y:e.height+e.y,x:e.x}:{y:(e=t.getPrevLayout()).y+e.height,x:e.x}:{y:t.getContainerLayout().contentY,x:t.getContainerLayout().contentX}},_refreshXAlign:function(){var t;5e3<n.outerWidth||n.end&&n.end.parent&&(t=n.outerWidth-n.width,"center"===n.end.parent.context.renderStyles.textAlign?t/=2:"left"===n.end.parent.context.renderStyles.textAlign&&(t=0),n.offsetX=t)},bindElement:function(t){var e;n.container=null==(e=t.parent)?void 0:e.context,n._initHeight(t),n.outerWidth=t.parent&&a(t.parent.context.styles.width)?1/0:null==(e=t.parent)?void 0:e.context.renderStyles.contentWidth,n.start=t,n.addElement(t)},refreshElementPosition:function(t){n.start===t&&n._initLayout(t),t.x=n.right+n.offsetX,t.y=n.y+n._getOffsetY(t),n.right+=t.renderStyles.width},addElement:function(t){n.elements.push(t),(t.line=n)._refreshWidthHeight(t),t.next&&"inline-block"===t.next.context.renderStyles.display||n._closeLine()},canIEnter:function(t){return!(t.renderStyles.width+n.width>n.outerWidth&&(n._closeLine(),1))}}).bindElement(p)},_bindFlexBox:function(){p.pre&&p.pre.line?p.pre.line.add(p):{key:null,exactValue:0,flexTotal:0,_closeLine:function(){_super.closeLine.call(this),this.calcFlex()},_initHeight:function(){this[this.key.height]=0},_refreshWidthHeight:function(t){t.renderStyles[this.key.height]>this[this.key.height]&&(this[this.key.height]=t.renderStyles[this.key.height]),this[this.key.width]+=t.renderStyles[this.key.width]},_initLayout:function(t){this.right=t.getContainerLayout()[this.key.contentX],this[this.key.x]=t.getContainerLayout()[this.key.contentX],this[this.key.y]=this.getPreLine(t)[this.key.y]},_refreshElementPosition:function(t){this.start===t&&this.initLayout(t),t[this.key.x]=this.right+this.offsetX,t[this.key.y]=this[this.key.y]+this.getOffsetY(t),this.right+=t.renderStyles[this.key.width]},_calcFlex:function(){var e=this,n=this.container.renderStyles[this.key.contentWidth];this.elements.forEach(function(t){C(t.styles.flex)&&(t.renderStyles[e.key.width]=t.styles.flex/e.flexTotal*(n-e.exactValue),t._refreshContentWithLayout())})},_refreshXAlign:function(){var t;this.end.parent&&(t=this.outerWidth-this[this.key.width],"center"===this.end.parent.renderStyles.justifyContent?t/=2:"flex-start"===this.end.parent.renderStyles.justifyContent&&(t=0),this.offsetX=t)},_getOffsetY:function(t){return"flex-end"===t.renderStyles.alignSelf?this.container.renderStyles[this.key.contentHeight]-t.renderStyles[this.key.height]:"center"===t.renderStyles.alignSelf?(this.container.renderStyles[this.key.contentHeight]-t.renderStyles[this.key.height])/2:0},bindElement:function(t){var e;this.container=t.parent,t.parent&&(this.key=q[t.parent.context.renderStyles.flexDirection]),this.initHeight(t),this.outerWidth=t.parent&&a(t.parent.context.styles[this.key.width])?1/0:null==(e=t.parent)?void 0:e.context.renderStyles[this.key.contentWidth],this.start=t,this.add(t)},addElement:function(t){C(t.styles[this.key.width])?this.exactValue+=t.renderStyles[this.key.width]:C(t.styles.flex)&&(this.flexTotal+=t.renderStyles.flex),this.elements.push(t),(t.line=this).refreshWidthHeight(t),t.next||this.closeLine()}}.bindElement(p)},_measureLayout:function(){var e=0,n=0;return p._getChildrenInFlow().forEach(function(t){t.line?t.line.start===t&&(t.line.width>e&&(e=t.line.width),n+=t.line.height):(t.renderStyles.width>e&&(e=t.renderStyles.width),n+=t.renderStyles.height)}),{width:e,height:n}},init:function(){console.log("init",p),p._initStyles()},appendChild:function(t){console.log("appendChild-----------",t,p),i.appendChild.call(this,t),this.layer.onElementAdd(t)},getContainerLayout:function(t){return{width:(t=(t=void 0===t?p.parent:t)||{renderStyles:{width:p.container?p.container.width:"100%",height:p.container?p.container.height:"100%",paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginLeft:0,marginRight:0,marginTop:0,marginBottom:0,contentWidth:p.container?p.container.width:"100%",contentHeight:p.container?p.container.height:"100%"},x:0,y:0,contentX:0,contentY:0}).renderStyles.width,height:t.renderStyles.height,x:t.x,y:t.y,paddingTop:t.renderStyles.paddingTop,paddingBottom:t.renderStyles.paddingBottom,paddingLeft:t.renderStyles.paddingLeft,paddingRight:t.renderStyles.paddingRight,marginLeft:t.renderStyles.marginLeft,marginRight:t.renderStyles.marginRight,marginTop:t.renderStyles.marginTop,marginBottom:t.renderStyles.marginBottom,contentX:t.contentX,contentY:t.contentY,contentWidth:t.renderStyles.contentWidth,contentHeight:t.renderStyles.contentHeight}},getPrevLayout:function(){for(var t=p.pre;t&&!t.isInFlow();)t=t.pre;return t?{width:t.renderStyles.width,height:t.renderStyles.height,x:t.x,y:t.y}:{width:0,height:0,x:p.getContainerLayout().contentX,y:p.getContainerLayout().contentY}},isInFlow:function(){var t=p.styles,e=t.position;return t.display,e!==I.POSITION.ABSOLUTE&&e!==I.POSITION.FIXED},isVisible:function(){return p.renderStyles.visible&&p.visible},getLayer:function(){return this.layer},getRenderer:function(){return this.layer.renderer},paint:function(t){}});return p.root=r.node,"text"!==p.type?v(v({},p),{paint:function(){console.log("paint-----");var t=this.getRenderer();this.options.render?this.options.render(t.getCtx(),t.getCanvas(),this):(t._drawBackground(this),t._drawBox(this))}}):d=v(v({},p),{layout:null,lines:[],debugColor:"blue",_paint:function(){d.getRender()._drawBackground(d),d.getRender()._drawText(d),d.getRender()._drawBox(d)},_getDefaultStyles:function(){return v(v({},I.DEFAULT_STYLES),{display:I.DISPLAY.INLINE_BLOCK,width:I.WIDTH.AUTO,textAlign:"left"})},_measureLayout:function(){return d.layout=d.getRender().measureText(d,d.children),d.layout.height=d.renderStyles.lineHeight,d._calcLine(),d.layout},_getFont:function(){var t=d.renderStyles,e=t.fontSize,n=t.fontWeight,t=t.fontFamily;return"".concat(n," ").concat(e,"px ").concat(t)},_calcLine:function(){if(d.parent&&d.children){var t=d.layout,e=t.width,n=(t.height,d.parent.context.renderStyles.contentWidth),t=d.parent.context.styles.width;if(a(d.styles.width)||(n=d.renderStyles.width),C(n)&&e<=n||t===I.WIDTH.AUTO)d.lines=[{text:d.children,layout:d.layout}];else{d.lines=[];for(var i,r=1,o="",l=null,s=0;s<d.children.length;s++){if((i=d.getRender().measureText(d,o+d.children[s]))&&i.width>n){if(r>=d.renderStyles.maxLine){o=o.substring(0,o.length-2)+"...";break}d.lines.push({text:o,layout:l||i}),o="",r+=1}o+=d.children[s],l=i}d.layout.width=n,d.lines.push({text:o,layout:d.getRender().measureText(d,o)}),d.layout.height=d.lines.length*d.renderStyles.lineHeight}}}})}}(e=A=A||{}).root="root",e.view="view",e.text="text",e.img="img";function H(t){var e=[];if(null!=t){var n,i,r=[];for(r.unshift(t);0!=r.length;)if(n=r.shift(),e.push(n),i=n.children,g(i))for(var o=i.length-1;0<=o;o--)r.push(i[o])}return e}function P(t){var e=[];if(null!=t){var n,i,r=[];for(r.unshift(t);0!=r.length;)if(n=r.shift(),e.push(n),i=n.children,g(i))for(var o=0;o<i.length;o++)r.push(i[o])}return e}function k(t){var e=t.renderStyles,n=e.paddingWidth,e=e.paddingHeight,t=t.renderStyles.borderRadius;return x(t=(t=e<2*(t=n<2*t?n/2:t)?e/2:t)<0?0:t)}function Q(t){var e,n;return{layer:t,imageBus:{},isAnimate:!1,lastPaintTime:0,lastFrameComplete:!1,throttle:(e=16,function(t){n=n||setTimeout(function(){t(),n=null},e)}),_restore:function(t){this.getCtx().save(),t(),this.getCtx().restore()},_path:function(t){this.getCtx().beginPath(),t(),this.getCtx().closePath()},_helpParentRestoreCtx:function(t){if(!(t.isVisible()&&(!(e=t).parent||e.next||e.hasChildren())||!t.isVisible()&&t.next)){this.getCtx().restore();for(var e,n=t.parent;n&&!n.next;)this.getCtx().restore(),n=n.parent}},_drawBox:function(t){var e,n,i,r,o,l,s,d,a,h,g,c,y,u,f,p,m,S,x,v=this;t.renderStyles={borderColor:"red",borderWidth:4,borderLeftWidth:4,borderRightWidth:4,borderTopWidth:4,borderBottomWidth:4,paddingLeft:0,paddingRight:0,paddingTop:0,paddingBottom:0,contentWidth:100,contentHeight:100},console.log("_drawBox-------",t,t.renderStyles),(t.renderStyles.borderColor||t.renderStyles.shadowBlur)&&(console.log("_drawBox-------"),n=(e=t.renderStyles).contentWidth,i=e.contentHeight,r=e.paddingLeft,o=e.paddingTop,l=e.borderStyle,s=e.paddingRight,d=e.paddingBottom,a=e.borderLeftWidth,h=e.borderRightWidth,g=e.borderTopWidth,c=e.borderBottomWidth,y=e.borderWidth,u=k(t),f=t.contentX-t.renderStyles.paddingLeft-a/2,p=t.contentY-t.renderStyles.paddingTop-g/2,m=n+r+s+(a+h)/2,S=i+o+d+(g+c)/2,this.getCtx().lineCap=t.renderStyles.lineCap,this.getCtx().strokeStyle=t.renderStyles.borderColor,this.getCtx().lineJoin="round",l&&"solid"!==l&&(Array.isArray(l)?this.getCtx().setLineDash(l):this.getCtx().setLineDash([5,5])),x=function(t){v.getCtx().lineWidth=t,v.getCtx().stroke()},this._restore(function(){v._path(function(){t.renderStyles.borderTopWidth&&(console.log(f,p),v.topBorder({x:f,y:p,borderRadius:u?u+t.renderStyles.borderTopWidth/2:0,w:m,h:S}),y||x(t.renderStyles.borderTopWidth)),t.renderStyles.borderRightWidth&&(v.getCtx().moveTo(f+m-u-(u?t.renderStyles.borderTopWidth/2:0),p),v.rightBorder({x:f,y:p,borderRadius:u?u+t.renderStyles.borderRightWidth/2:0,w:m,h:S}),y||x(t.renderStyles.borderRightWidth)),t.renderStyles.borderBottomWidth&&(v.getCtx().moveTo(f+m,p+S-u-(u?t.renderStyles.borderRightWidth/2:0)),v.bottomBorder({x:f,y:p,borderRadius:u?u+t.renderStyles.borderBottomWidth/2:0,w:m,h:S}),y||x(t.renderStyles.borderBottomWidth)),t.renderStyles.borderLeftWidth&&(v.getCtx().moveTo(f+u+(u?t.renderStyles.borderBottomWidth/2:0),p+S),v.leftBorder({x:f,y:p,borderRadius:u?u+t.renderStyles.borderLeftWidth/2:0,w:m,h:S}),x(t.renderStyles.borderLeftWidth))})}))},_drawBackground:function(t){var e=this,n=t.renderStyles,i=n.backgroundColor,r=n.contentWidth,o=n.contentHeight,l=n.shadowColor,s=n.shadowBlur,d=n.paddingLeft,a=n.paddingRight,h=n.paddingTop,g=n.paddingBottom,c=n.opacity,y=n.shadowOffsetX,u=n.shadowOffsetY,f=n.borderLeftWidth,p=n.borderRightWidth,m=n.borderTopWidth,n=n.borderBottomWidth,S=this.getCtx(),x=k(t),v=t.contentX-t.renderStyles.paddingLeft-f,_=t.contentY-t.renderStyles.paddingTop-m,w=r+d+a+(f+p),L=o+h+g+(m+n);C(c)&&(S.globalAlpha=c),l&&s&&this._restore(function(){e._path(function(){e.topBorder({x:v,y:_,borderRadius:x,w:w,h:L}),e.rightBorder({x:v,y:_,borderRadius:x,w:w,h:L}),e.bottomBorder({x:v,y:_,borderRadius:x,w:w,h:L}),e.leftBorder({x:v,y:_,borderRadius:x,w:w,h:L})}),C(y)&&(e.getCtx().shadowOffsetX=y),C(u)&&(e.getCtx().shadowOffsetY=u),e.getCtx().shadowBlur=s,e.getCtx().shadowColor=l,e.getCtx().fillStyle=l,e.getCtx().fill()}),this._clip(t),i&&(this.getCtx().fillStyle=this._parseBackground(i,t),this.getCtx().fillRect(t.contentX-d,t.contentY-h,r+d+a,o+h+g)),this.isDebug()&&(this.getCtx().strokeStyle=t.debugColor||"green",this.getCtx().strokeRect(t.contentX,t.contentY,t.renderStyles.contentWidth,t.renderStyles.contentHeight))},_clip:function(t){var e,n,i,r,o,l,s,d,a,h,g,c,y,u,f,p=this;"hidden"===t.renderStyles.overflow&&(e=(h=t.renderStyles).contentWidth,n=h.contentHeight,i=h.paddingLeft,r=h.paddingTop,o=h.paddingRight,l=h.paddingBottom,s=h.borderLeftWidth,d=h.borderRightWidth,a=h.borderTopWidth,h=h.borderBottomWidth,g=k(t),c=t.contentX-t.renderStyles.paddingLeft-.7*s,y=t.contentY-t.renderStyles.paddingTop-.7*a,u=e+i+o+.7*(s+d),f=n+r+l+.7*(a+h),this._path(function(){p.topBorder({x:c,y:y,borderRadius:g,w:u,h:f}),p.rightBorder({x:c,y:y,borderRadius:g,w:u,h:f}),p.bottomBorder({x:c,y:y,borderRadius:g,w:u,h:f}),p.leftBorder({x:c,y:y,borderRadius:g,w:u,h:f})}),this.getCtx().clip())},_parseBackground:function(t,e){if(Array.isArray(t)){for(var n=this.getCtx().createLinearGradient(e.contentX,e.contentY,e.contentX+e.renderStyles.contentWidth,e.contentY+e.renderStyles.contentHeight),i=0;i<t.length;i++)0===i?n.addColorStop(0,t[0]):n.addColorStop(i/(t.length-1),t[i]);return n}return t},_drawText:function(n){for(var i,r=this,t=n.renderStyles,o=t.color,e=t.contentWidth,l=t.lineHeight,s=t.textAlign,d=t.textIndent,a=t.textDecoration,h=n.contentX,g=(this.getCtx().fillStyle=o,this.getCtx().textAlign=s,this.getCtx().font=n._getFont(),this.getCtx().textBaseline="middle",s===I.TEXT_ALIGN.RIGHT?h=n.contentX+e:s===I.TEXT_ALIGN.CENTER&&(h=n.contentX+e/2),h),c=0,y=this,u=0;u<n._lines.length;u++)!function(t){var e;i=n._lines[t],g=0===t&&d?h+d:h,c=n.contentY+l/2+l*t+.5,y.getCtx().fillText(i.text,g,c),f&&400!==n.renderStyles.fontWeight&&(t=.001*n.renderStyles.fontSize,y.getCtx().fillText(i.text,g-t,c)),a&&(e=a[0],c+=1,y._restore(function(){r._path(function(){var t=c;"underline"===e?t=c+n._layout.fontHeight/2:"line-through"===e&&(t=c),r.getCtx().moveTo(g,t),r.getCtx().lineTo(g+i.layout.width,t)}),r.getCtx().strokeStyle=o,r.getCtx().stroke()}))}(u)},_drawImage:function(t){var e,n,i,r,o,l,s,d,a,h,g,c,y;t._image&&(e=(n=t.renderStyles).contentWidth,n=n.contentHeight,i=t.options.attrs.mode,r=(y=t._imageInfo).sx,o=y.sy,l=y.swidth,s=y.sheight,d=y.dx,a=y.dy,h=y.dwidth,g=y.dheight,c=y.width,y=y.height,"aspectFill"===i?this.getCtx().drawImage(t._image,r,o,l,s,t.contentX,t.contentY,e,n):"aspectFit"===i?this.getCtx().drawImage(t._image,0,0,c,y,d,a,h,g):this.getCtx().drawImage(t._image,t.contentX,t.contentY,e,n))},_drawScroll:function(t){this.getCtx().translate(t.currentScrollX,t.currentScrollY)},_animate:function(){var t=this,e=Date.now();this.render(this.element),this.isAnimate&&window.requestAnimationFrame(function(){return t._animate(e)})},isDebug:function(){return this.getLayer().options&&this.getLayer().options.debug},getCtx:function(){return this.layer.ctx},getLayer:function(){return this.layer},paint:function(t){console.log("renderer-paint-----------"),this.getCtx().save(),t.paint(this.lastPaintTime),this.afterPaint(t)},afterPaint:function(t){t.hasChildren()&&"text"!==t.type||this.getCtx().restore(),this._helpParentRestoreCtx(t)},topBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,r=t.w;t.h,this.getCtx().moveTo(e,n+i),i&&this.getCtx().arc(e+i,n+i,i,2*angle,3*angle),this.getCtx().lineTo(e+r-i,n)},rightBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,r=t.w,t=t.h;i&&this.getCtx().arc(e+r-i,n+i,i,3*angle,4*angle),this.getCtx().lineTo(e+r,n+t-i)},bottomBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,r=t.w,t=t.h;i&&this.getCtx().arc(e+r-i,n+t-i,i,0,angle),this.getCtx().lineTo(e+i,n+t)},leftBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,t=(t.w,t.h);i&&this.getCtx().arc(e+i,n+t-i,i,angle,2*angle),this.getCtx().lineTo(e,n+i)},measureText:function(n,i){var r=this,o=0,l=0;return this._restore(function(){r.getCtx().font=n._getFont();var t=r.getCtx().measureText(i),e=t.width,t=t.actualBoundingBoxAscent;o=e,l=t||.7*n.renderStyles.fontSize}),{width:o,fontHeight:l+1}},getImageInstance:function(t){var i,e,r=this,o=null;return this.imageBus[t]?o=this.imageBus[t]:(f?o=this.getCanvas()?this.getCanvas().createImage():(console.warn("小程序请使用设置canvas参数以创建图片"),i=t,e={onload:function(){}},new Promise(function(n,e){wx.downloadFile({url:i,success:function(e){wx.getImageInfo({src:e.tempFilePath,success:function(t){n({target:{width:t.width,height:t.height},image:e.tempFilePath})}})},fail:function(t){e(t)}})}).then(function(t){e.onload(t)}).catch(function(t){}),e):(o=new Image).crossOrigin="anonymous",t&&(this.imageBus[t]=new Promise(function(e,n){o.onload=function(t){e({image:f&&!r.getCanvas()?t.image:o,info:{width:(f?o:t.target).width,height:(f?o:t.target).height}})},o.onerror=function(t){n(t)}})),o.src=t),this.imageBus[t]},render:function(t){var r=this,e=(this.lastFrameComplete=!1,this.lastPaintTime=Date.now(),console.log("render----------",t,this.getCtx(),this.getLayer()),t.parent?this.getCtx().clearRect(t.x,t.y,t.renderStyles.width,t.renderStyles.height):this.getCtx().clearRect(0,0,this.getLayer().options.width,this.getLayer().options.height),function(t,e,n){var i;console.log("walk-------------",t),(i=t)&&!0===i.__v_isElement&&(t.isVisible&&t.isVisible()?r.paint(t):(n(),r._helpParentRestoreCtx(t)))});function n(){return o=!0}function i(){return l=!0}var o=!1,l=!1;if(null!=t){var s,d,a=[];for(a.push(t);0!==a.length&&(console.log("stack",a),s=a.pop(),console.log("item",s),s);)if(e(s,n,i),!l&&s){if(d=s.children,console.log("children",d),!g(d))break;for(var h=d.length-1;0<=h;h--)o?o=!1:a.push(d[h])}else l=!1}f&&this.getCtx().draw&&this.getCtx().draw(),this.lastFrameComplete=!0},renderFPS:function(){},readyToRender:function(t){console.log("_readyToRender"),this.element=t;var e=this.getLayer().options;this.lastPaintTime=Date.now(),e&&e.animate?this.animate():this.render(t)},requestRepaint:function(t){this.isAnimate||this.render(this.element)},getCanvas:function(){var t=this.getLayer().options;return t&&t.canvas||null},stopAnimate:function(){this.isAnimate=!1},onEffectFinished:function(){var e=this,t=Object.keys(this.imageBus).map(function(t){return e.imageBus[t]});return Promise.all(t)}}}return{createNodeOps:function(n){return{insert:function(t,e,n){console.log("insert-------------",t,e,n),t&&e.appendChild(t)},remove:function(t){console.log("remove-------------",t)},createElement:function(t,e){console.log("createElement------------",t,e);t=(e=e||{}).style;return n(A.view,{style:t})},createText:function(t){return n(A.text,{},t)},createComment:function(t){},setText:function(t,e){},setElementText:function(t,e){},parentNode:function(t){return t.parentNode},nextSibling:function(t){return t.nextSibling}}},createRenderer:function(t){function e(t,e){null==t?e._vnode&&m(e._vnode,null,!0):c(e._vnode||null,t,e,null,null);var n=void 0,i=void 0;for(void 0===i&&(i=0),n=n||new Map;i<T.length;i++){var r=T[i];r&&r.pre&&(B(n,r)||(T.splice(i,1),i--,r()))}K(),e._vnode=t}var o,d=t.insert,n=t.remove,a=t.patchProp,h=t.createElement,r=t.createText,l=(t.createComment,t.setText),g=t.setElementText,i=(t.parentNode,t.nextSibling),c=function(t,e,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),t!==e&&(t&&t.type!==e.type&&(i=v(t),m(t,r,!0),t=null),"Text"===e.type?s(t,e,n,i):y(t,e,n,i,r))},s=function(t,e,n,i){null==t?d(r(e.children),n,i):e.children!==t.children&&l(e,e.children)},y=function(t,e,n,i,r){if(null==t)n=n,i=i,l=r,(o=e).type,s=o.props,s=o.el=h(o.type,s),u(o.children,s,null,l),d(s,n,i);else{o=t,l=e,s=r,n=l.el=o.el,i=o.props||_,t=l.props||_;if(f(o,l,n,null,s),o.children!==l.children)g(n,l.children);p(n,l,i,t,s)}var o,l,s},u=function(t,e,n,i,r){if(void 0===r&&(r=0),"string"==typeof t)c(null,b(t),e,n,i);else for(var o=r;o<t.length;o++){var l=b(t[o]);c(null,l,e,n,i)}},f=function(t,e,n,i,r){for(var t=t&&t.children,e=e.children,o=t,l=e,s=n,t=i,d=r,e=(o=o||w).length,n=(l=l||w).length,a=Math.min(e,n),h=0;h<a;h++){var g=b(l[h]);c(o[h],g,s,null,d)}n<e?x(o,d,!0,!1,a):u(l,s,t,d,a)},p=function(t,e,n,i,r){if(n!==i){if(n!==_)for(var o in n)a(t,o,n[o],null,e.children,r,x);for(var o in i){var l=i[o],s=n[o];l!==s&&"value"!==o&&a(t,o,s,l,e.children,r,x)}"value"in i&&a(t,"value",n.value,i.value)}},m=function(t,e,n,i){void 0===n&&(n=!1),t.type,t.props;var r=t.children;x(r,e),n&&S(t)},S=function(t){n(t)},x=function(t,e,n,i,r){void 0===n&&(n=!1);for(var o=r=void 0===r?0:r;o<t.length;o++)m(t[o],e,n)},v=function(t){return i(t)};return{render:e,createApp:(o=e,function(n,i){var r={_uid:j++,_component:n,_props:i=void 0===i?null:i,_container:null,_instance:null,mount:function(t){var e=L(n,i);r._container=t,o(e,t)}};return r})}},h:function(t,e,n){var i=arguments.length;return console.log("h",i,t,e,n),2===i?s(e)&&!g(e)?d(e)?L(t,null,[e]):L(t,e):L(t,null,e):(3<i?n=Array.prototype.slice.call(arguments,2):3===i&&d(n)&&(n=[n]),L(t,e,n))},createLayer:function(t,e){function n(){return r(A.root,{},[])}var i={ctx:t,node:null,p2cList:[],c2pList:[],nodeList:[],options:e,renderer:null,_initRender:function(){var t=Date.now();!function n(i){console.warn("connectChildren",i),i.hasChildren()&&(i.children=i.children.filter(function(t){E(t)}),i._getChildren().map(function(t,e){t._setParent(i),t._setSibling(i._getChildren()[e-1],i._getChildren()[e+1]),n(t)}))}(i.node),i._initC2PList(),i._initP2CList(),console.log("initRender",i.c2pList,i.p2cList),i._flow(),i.renderer.onEffectFinished().then(function(t){return i.lifecycle("onEffectSuccess",t)}).catch(function(t){return i.lifecycle("onEffectFail",t)}),i._repaint(),console.log("渲染".concat(i.p2cList.length,"个元素 耗时 ").concat(Date.now()-t," ms"))},_initP2CList:function(){i.node&&(i.p2cList=P(i.node))},_initC2PList:function(){i.node&&(i.c2pList=H(i.node))},_flow:function(){for(var t=0;t<i.p2cList.length;t++)i.p2cList[t].init();i._reflow()},_reflow:function(){},_initPaintList:function(){},_reflowElement:function(t){for(var e=t;e&&e.line;)e=e.parent;for(var n=P(e),i=0;i<n.length;i++)n[i]._initStyles();for(var r=H(e),i=0;i<r.length;i++)r[i]._initWidthHeight();if(t.isInFlow())this.onElementChange(e);else{for(i=0;i<n.length;i++)n[i]._initPosition();this._repaint()}},_callBeforePaint:function(){for(var t=0;t<i.p2cList.length;t++)i.p2cList[t].beforePaint&&i.p2cList[t].beforePaint()},_repaint:function(t){if(void 0===t&&(t=i.node),console.log("_repaint---------------"),(t=f?i.node:t)&&!t.isInFlow()&&(t=i.node),i._callBeforePaint(),!i.node||!i.renderer)throw Error("repaint need node in layer");i.renderer.readyToRender(i.node)},update:function(t,e){i.ctx=t,i.options=e,i.options.renderStyles=e},init:function(){i.renderer=Q(i),i._initRender()},onElementRemove:function(){},onElementAdd:function(t){i._initC2PList(),i._initP2CList(),console.log("onElementAdd",i.p2cList),i.p2cList.forEach(function(t){t.init()}),i._reflowElement(t)},onElementChange:function(t){console.log("onElementChange-------"),o(t,function(t,e){t._initWidthHeight(),"scroll-view"===t.type&&e()});for(var e=0;e<i.p2cList.length;e++)i.p2cList[e]._initPosition();i._repaint()},animate:function(){console.warn("use [animate] option instead!")},getElementBy:function(){var t;return(t=i.node).getElementBy.apply(t,arguments)},lifecycle:function(t,e){i.options.lifecycle&&i.options.lifecycle[t]&&i.options.lifecycle[t](e)}},r=J(i);return i.node=n(),console.info("init-layer------------------------",i),(i.node.layer=i).node.root=i.node,i.init(),{layer:i,createCanvasElement:r,createRootCanvasElement:n}}}});
//# sourceMappingURL=x-canvas.js.map
