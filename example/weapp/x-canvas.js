!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).XCanvas=e()}(this,(function(){"use strict";var t=function(){return t=Object.assign||function(t){for(var e,n=arguments,i=1,r=arguments.length;i<r;i++)for(var o in e=n[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},t.apply(this,arguments)};function e(t,e,n){if(n||2===arguments.length)for(var i,r=0,o=e.length;r<o;r++)!i&&r in e||(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return t.concat(i||Array.prototype.slice.call(e))}var n=Object.freeze({}),i=Object.freeze([]),r=function(){},o=/^on[^a-z]/,a=function(t){return o.test(t)},d=Object.assign,l=function(t){return p.call(null,t)},s=function(t){return"auto"===t},h=function(t){if(f(t))return u(t.match("%"))},c=function(t){var e=parseInt(t.replace("%",""));return isNaN(e)||e<0?0:e/100},u=Array.isArray,g=function(t){return"function"==typeof t},f=function(t){return"string"==typeof t},p=function(t){return"number"==typeof t},y=function(t){return null!==t&&"object"==typeof t},m=function(t){for(var n,i,r=arguments,o=[],a=1;a<arguments.length;a++)o[a-1]=r[a];if(!o.length)return t;var d=o.shift();if(y(t)&&y(d))for(var l in d)y(d[l])?(t[l]||Object.assign(t,((n={})[l]={},n)),m(t[l],d[l])):Object.assign(t,((i={})[l]=d[l],i));return m.apply(void 0,e([t],o,!1))};var v=function(){try{return Boolean(wx.getSystemInfoSync)}catch(t){return!1}}();function x(t){if(u(t)){for(var e={},n=0;n<t.length;n++){var i=t[n],r=f(i)?S(i):x(i);if(r)for(var o in r)e[o]=r[o]}return e}return f(t)||y(t)?t:void 0}var C,b=/;(?![^(]*\))/g,_=/:([^]+)/,T=/\/\*.*?\*\//gs;function S(t){var e={};return t.replace(T,"").split(b).forEach((function(t){if(t){var n=t.split(_);n.length>1&&(e[n[0].trim()]=n[1].trim())}})),e}function w(t){var e="";if(f(t))e=t;else if(u(t))for(var n=0;n<t.length;n++){var i=w(t[n]);i&&(e+=i+" ")}else if(y(t))for(var r in t)t[r]&&(e+=r+" ");return e.trim()}(C={})[1]="TEXT",C[2]="CLASS",C[4]="STYLE",C[8]="PROPS",C[16]="FULL_PROPS",C[32]="HYDRATE_EVENTS",C[64]="STABLE_FRAGMENT",C[128]="KEYED_FRAGMENT",C[256]="UNKEYED_FRAGMENT",C[512]="NEED_PATCH",C[1024]="DYNAMIC_SLOTS",C[2048]="DEV_ROOT_FRAGMENT",C[-1]="HOISTED",C[-2]="BAIL";var L=Symbol.for("v-fgt"),R=Symbol.for("v-cmt");function W(t){return!!t&&!0===t.__v_isVNode}function B(t,e,n,i){if(void 0===e&&(e=null),void 0===n&&(n=null),W(t)){var r=E(t,e);return n&&function(t,e){null==e?e=null:u(e)||"object"==typeof e||g(e)||(e=[I(e)]);t.children=e}(r,n),r}if(e){var o=e.class,a=e.style;o&&!f(o)&&(e.class=w(o)),y(a)&&(e.style=x(a))}return function(t,e,n,i){return void 0===e&&(e=null),void 0===n&&(n=null),{__v_isVNode:!0,__v_skip:!0,type:t,props:e,children:n,component:null,el:null,staticCount:0,appContext:null,ctx:null}}(t,e,n)}function E(t,e,n){if(t&&"object"!=typeof t)return t;var i=t.props,r=t.children,o=e?function(){for(var t=arguments,e=[],n=0;n<arguments.length;n++)e[n]=t[n];for(var i={},r=0;r<e.length;r++){var o=e[r];for(var d in o)if("class"===d)i.class!==o.class&&(i.class=w([i.class,o.class]));else if("style"===d)i.style=x([i.style,o.style]);else if(a(d)){var l=i[d],s=o[d];!s||l===s||u(l)&&l.includes(s)||(i[d]=l?[].concat(l,s):s)}else""!==d&&(i[d]=o[d])}return i}(i||{},e):i;return{__v_isVNode:!0,type:t.type,props:o,children:u(r)?r.map(A):r,staticCount:t.staticCount,appContext:t.appContext,component:t.component,el:t.el,ctx:t.ctx}}function A(t){var e=E(t);return u(t.children)&&(e.children=t.children.map(A)),e}function I(t,e){return void 0===t&&(t=" "),B("Text",null,t)}function O(t){return null==t||"boolean"==typeof t?B(R):u(t)?B(L,null,t.slice()):"object"==typeof t?function(t){return E(t)}(t):I(String(t))}var P=0;function N(t){return function(e,n){void 0===n&&(n=null);var i={_uid:P++,_component:e,_props:n,_container:null,_instance:null,mount:function(r){var o=B(e,n);i._container=r,t(o,r)}};return i}}var D=[],H=[],F=null,Y=0,X=100;var k=function(t){return null==t.id?1/0:t.id};function U(t,e){if(t.has(e)){var n=t.get(e);if(n>X)return!0;t.set(e,n+1)}else t.set(e,1)}function j(t){return!!t&&!0===t.__v_isTreeNode}function z(t){t.hasChildren()&&(t.children=t.children.filter((function(t){j(t)})),t._getChildren().map((function(e,n){e._setParent(t),e._setSibling(t._getChildren()[n-1],t._getChildren()[n+1]),z(e)})))}var G={BLOCK:"block",INLINE_BLOCK:"inline-block",INLINE:"inline",FLEX:"flex",NONE:"none"},V={AUTO:"auto",OUTER:"100%"},M={ROW:"row",COLUMN:"column"},K={DISPLAY:G,WIDTH:V,POSITION:{ABSOLUTE:"absolute",FIXED:"fixed",RELATIVE:"relative",STATIC:"static"},TEXT_ALIGN:{LEFT:"left",RIGHT:"right",CENTER:"center"},FLEX_DIRECTION:M,DEFAULT_STYLES:{display:G.BLOCK,fontSize:14,fontWeight:400,fontFamily:"sans-serif",color:"#000",paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginTop:0,marginBottom:0,marginLeft:0,marginRight:0,width:V.AUTO,height:V.AUTO,borderRadius:0,borderColor:"#000",lineCap:"square",flexDirection:M.ROW,verticalAlign:"middle",textAlign:"left",justifyContent:"flex-start",alignItems:"flex-start",alignSelf:"auto",whiteSpace:"normal",zIndex:1,position:"static"}};function q(t,e,n){!function(t,e){e.display===K.DISPLAY.FLEX&&(t.flex?"column"===e.flexDirection&&l(t.flex)?t.height=0:"row"===e.flexDirection&&l(t.flex)&&(t.width=0):l(t.height)||l(t.width)||(t.flex=1))}(t,e),function(t,e,n){t.width||(t.display!==K.DISPLAY.INLINE_BLOCK&&t.display!==K.DISPLAY.INLINE&&n?t.display===K.DISPLAY.BLOCK||t.display===K.DISPLAY.FLEX?t.width=K.WIDTH.OUTER:t.width=0:t.width=K.WIDTH.AUTO);h(t.width)&&s(e.width)&&(t.width=K.WIDTH.AUTO);h(t.height)&&s(e.height)&&(t.height=K.WIDTH.AUTO)}(t,e,n),function(t){var e=t.borderWidth,n=t.borderLeftWidth,i=t.borderRightWidth,r=t.borderBottomWidth,o=t.borderTopWidth,a=t.borderRadius;e||(t.borderWidth=0,e=0);Array.isArray(e)?(t.borderTopWidth=e[0],t.borderRightWidth=e[1],t.borderBottomWidth=e[2],t.borderLeftWidth=e[3]):(n||(t.borderLeftWidth=e),i||(t.borderRightWidth=e),r||(t.borderBottomWidth=e),o||(t.borderTopWidth=e));a&&(t.overflow="hidden")}(t),function(t){t.fontSize&&!t.lineHeight&&(t.lineHeight=1.4*t.fontSize)}(t),function(t){t.padding&&(l(t.padding)?(t.paddingLeft=t.padding,t.paddingBottom=t.padding,t.paddingRight=t.padding,t.paddingTop=t.padding):Array.isArray(t.padding)&&(2===t.padding.length?(t.paddingLeft=t.paddingRight=t.padding[1],t.paddingBottom=t.paddingTop=t.padding[0]):4===t.padding.length&&(t.paddingLeft=t.padding[3],t.paddingBottom=t.padding[2],t.paddingRight=t.padding[1],t.paddingTop=t.padding[0])));l(t.margin)?(t.marginLeft=t.margin,t.marginBottom=t.margin,t.marginRight=t.margin,t.marginTop=t.margin):Array.isArray(t.margin)&&(2===t.margin.length?(t.marginLeft=t.marginRight=t.margin[1],t.marginBottom=t.marginTop=t.margin[0]):4===t.margin.length&&(t.marginLeft=t.margin[3],t.marginBottom=t.margin[2],t.marginRight=t.margin[1],t.marginTop=t.margin[0]))}(t)}var J=function(t){return function e(){for(var n=arguments,i=[],r=0;r<arguments.length;r++)i[r]=n[r];return i.length>=t.length?t.apply(this,i):function(){for(var t=arguments,n=[],r=0;r<arguments.length;r++)n[r]=t[r];return e.apply(this,i.concat(n))}}};var Q={styles:{},renderStyles:{width:0,height:0,paddingWidth:0,paddingHeight:0,paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginLeft:0,marginRight:0,marginTop:0,marginBottom:0,borderTopWidth:0,borderBottomWidth:0,borderLeftWidth:0,borderRightWidth:0,contentWidth:0,contentHeight:0,fullBoxWidth:0,fullBoxHeight:0,lineCap:"butt",visible:!0},layout:{x:0,y:0,contentX:0,contentY:0}};function Z(e){return function(n,i,o){void 0===i&&(i={});var a=function(t){void 0===t&&(t=[]);var e={__v_isTreeNode:!0,_children:t,parent:null,root:null,prev:null,next:null,get children(){return e._children},hasChildren:function(){return!(!Array.isArray(e._children)||!e._children.length)},appendChild:function(t){if(!j(t))throw Error("Unknown treeNode type");var i,r=e._children[e._children.length-1]||null;r&&j(r)&&n(r,r.prev,t),Array.isArray(e._children)&&e._children.push(t),i=this,t.parent=i,n(t,r,null)},prependChild:function(t){if(!j(t))throw Error("Unknown treeNode type")},removeChild:function(t){if(!j(t))throw Error("Unknown treeNode type")},append:function(){},prepend:function(){},remove:function(){}};function n(t,e,n){t.prev=e,t.next=n}return e}(o),h={__v_isRenderableElement:!0,paint:r},c={__v_isCanvasElement:!0,type:n,options:i,styles:{},layout:{x:0,y:0,contentX:0,contentY:0},renderStyles:{},debugColor:null,container:m(Q,{renderStyles:{contentWidth:e.options.width,contentHeight:e.options.height}}),relativeTo:null,layer:e,line:null},u=t(t(t(t({},c),a),h),{appendChild:function(t){a.appendChild.call(u,t),t.container=u,e.onElementAdd(t)},initRenderStyles:function(){u.styles=function(t){var e=m({},K.DEFAULT_STYLES,function(t){var e={};return["textAlign","fontFamily","fontWeight","fontSize","lineHeight","wordSpacing","letterSpacing","color","alignItems","visibility"].map((function(n){var i=t.container.styles[n];i&&(e[n]=i)})),e}(t),t.options.style||{});"root"===t.type&&(e.width="100%",e.height="100%");return q(e,t.container.styles,!0),e}(u),u.renderStyles=function(t){var e={};d(e,t.styles);var n=t.container.renderStyles.contentWidth,i=t.container.renderStyles.contentHeight;return e.paddingWidth=$(t.styles.width,n,e.marginLeft+e.marginRight),e.paddingHeight=$(t.styles.height,i,e.marginTop+e.marginBottom),e.contentWidth=et(e,["paddingWidth","paddingLeft","paddingRight"]),e.contentHeight=et(e,["paddingHeight","paddingTop","paddingBottom"]),e.fullBoxWidth=nt(e,["contentWidth","paddingLeft","paddingRight","borderLeftWidth","borderRightWidth","marginLeft","marginRight"]),e.fullBoxHeight=nt(e,["contentHeight","paddingTop","paddingBottom","borderTopWidth","borderBottomWidth","marginTop","marginBottom"]),e.width=e.paddingWidth+e.marginLeft+e.marginRight+function(t){return t.borderLeftWidth+t.borderRightWidth}(e),e.height=e.paddingHeight+e.marginTop+e.marginBottom+function(t){return t.borderTopWidth+t.borderBottomWidth}(e),console.log("renderStyles",e),e}(u),console.log("initRenderStyles",u,u.renderStyles)},getRenderer:function(){return e.renderer},isVisible:function(){return!0}});return u.root=e.node,"root"===u.type&&(u.options.style={width:"100%",height:"100%"}),"text"===u.type?function(e){var n=t(t({},e),{layout:null,lines:[],debugColor:"blue",_getDefaultStyles:function(){return t(t({},K.DEFAULT_STYLES),{display:K.DISPLAY.INLINE_BLOCK,width:K.WIDTH.AUTO,textAlign:"left"})},_measureLayout:function(){return n.layout=n.getRenderer().measureText(n,n.children),n.layout.height=n.renderStyles.lineHeight,n._calcLine(),n.layout},_getFont:function(){var t=n.renderStyles,e=t.fontSize,i=t.fontWeight,r=t.fontFamily;return"".concat(i," ").concat(e,"px ").concat(r)},_calcLine:function(){if(n.parent&&n.children){var t=n.layout,e=t.width;t.height;var i=n.parent.renderStyles.contentWidth,r=n.parent.styles.width;if(s(n.styles.width)||(i=n.renderStyles.width),l(i)&&i>=e||r===K.WIDTH.AUTO)n.lines=[{text:n.children,layout:n.layout}];else{n.lines=[];for(var o=1,a="",d=null,h=null,c=0;c<n.children.length;c++){if((d=n.getRenderer().measureText(n,a+n.children[c]))&&d.width>i){if(o>=n.renderStyles.maxLine){a=a.substring(0,a.length-2)+"...";break}n.lines.push({text:a,layout:h||d}),a="",o+=1}a+=n.children[c],h=d}n.layout.width=i,n.lines.push({text:a,layout:n.getRenderer().measureText(n,a)}),n.layout.height=n.lines.length*n.renderStyles.lineHeight}}},paint:function(){var t=this.getRenderer();t._drawBackground(n),t._drawText(n),t._drawBox(n)}});return n}(u):function(e){return t(t({},e),{paint:function(){var t=this.getRenderer();this.options.render?this.options.render(t.getCtx(),t.getCanvas(),this):(t._drawBackground(this),t._drawBox(this))}})}(u)}}function $(t,e,n){var i=0;return s(t)||(i=h(t)?c(t)*e-n:t),i}var tt=function(t,e){var n=[];return e.map((function(e){return n.push(t[e])})),n},et=function(t,e){return J((function(t,e,n){return t-e-n})).apply(void 0,tt(t,e))},nt=function(t,e){return J((function(t,e,n,i,r,o,a){return t+e+n+i+r+o+a})).apply(void 0,tt(t,e))},it=function(t){var e=[];if(null!=t){var n=[],i=void 0,r=void 0;for(n.unshift(t);0!=n.length;)if(i=n.shift(),e.push(i),r=i.children,u(r))for(var o=0;o<r.length;o++)n.push(r[o])}return e};function rt(t){var e=t.renderStyles,n=e.paddingWidth,i=e.paddingHeight,r=t.renderStyles.borderRadius;return 2*r>n&&(r=n/2),2*r>i&&(r=i/2),r<0&&(r=0),.5+r<<0}function ot(t){var e,n,i={layer:t,imageBus:{},isAnimate:!1,lastPaintTime:0,lastFrameComplete:!1,throttle:(e=16,function(t){n||(n=setTimeout((function(){t(),n=null}),e))}),_restore:function(t){this.getCtx().save(),t(),this.getCtx().restore()},_path:function(t){this.getCtx().beginPath(),t(),this.getCtx().closePath()},_helpParentRestoreCtx:function(t){if(!(t.isVisible()&&(e=t,!e.parent||e.next||e.hasChildren())||!t.isVisible()&&t.next)){var e;this.getCtx().restore();for(var n=t.parent;n&&!n.next;)this.getCtx().restore(),n=n.parent}},_drawBox:function(t){var e=this;if(t.renderStyles={borderColor:"red",borderWidth:4,borderLeftWidth:4,borderRightWidth:4,borderTopWidth:4,borderBottomWidth:4,paddingLeft:0,paddingRight:0,paddingTop:0,paddingBottom:0,contentWidth:100,contentHeight:100},t.renderStyles.borderColor||t.renderStyles.shadowBlur){var n=t.renderStyles,i=n.contentWidth,r=n.contentHeight,o=n.paddingLeft,a=n.paddingTop,d=n.borderStyle,l=n.paddingRight,s=n.paddingBottom,h=n.borderLeftWidth,c=n.borderRightWidth,u=n.borderTopWidth,g=n.borderBottomWidth,f=n.borderWidth,p=rt(t),y=t.contentX-t.renderStyles.paddingLeft-h/2,m=t.contentY-t.renderStyles.paddingTop-u/2,v=i+o+l+(h+c)/2,x=r+a+s+(u+g)/2;this.getCtx().lineCap=t.renderStyles.lineCap||"butt",this.getCtx().strokeStyle=t.renderStyles.borderColor,this.getCtx().lineJoin="round",d&&"solid"!==d&&(Array.isArray(d)?this.getCtx().setLineDash(d):this.getCtx().setLineDash([5,5]));var C=function(t){e.getCtx().lineWidth=t,e.getCtx().stroke()};this._restore((function(){e._path((function(){t.renderStyles.borderTopWidth&&(e.topBorder({x:y,y:m,borderRadius:p?p+t.renderStyles.borderTopWidth/2:0,w:v,h:x}),!f&&C(t.renderStyles.borderTopWidth)),t.renderStyles.borderRightWidth&&(e.getCtx().moveTo(y+v-p-(p?t.renderStyles.borderTopWidth/2:0),m),e.rightBorder({x:y,y:m,borderRadius:p?p+t.renderStyles.borderRightWidth/2:0,w:v,h:x}),!f&&C(t.renderStyles.borderRightWidth)),t.renderStyles.borderBottomWidth&&(e.getCtx().moveTo(y+v,m+x-p-(p?t.renderStyles.borderRightWidth/2:0)),e.bottomBorder({x:y,y:m,borderRadius:p?p+t.renderStyles.borderBottomWidth/2:0,w:v,h:x}),!f&&C(t.renderStyles.borderBottomWidth)),t.renderStyles.borderLeftWidth&&(e.getCtx().moveTo(y+p+(p?t.renderStyles.borderBottomWidth/2:0),m+x),e.leftBorder({x:y,y:m,borderRadius:p?p+t.renderStyles.borderLeftWidth/2:0,w:v,h:x}),C(t.renderStyles.borderLeftWidth))}))}))}},_drawBackground:function(t){var e=this;if(t.layout){console.log("_drawBackground",t);var n=t.renderStyles,i=n.backgroundColor,r=n.contentWidth,o=n.contentHeight,a=n.shadowColor,d=n.shadowBlur,s=n.paddingLeft,h=n.paddingRight,c=n.paddingTop,u=n.paddingBottom,g=n.opacity,f=n.shadowOffsetX,p=n.shadowOffsetY,y=n.borderLeftWidth,m=n.borderRightWidth,v=n.borderTopWidth,x=n.borderBottomWidth,C=this.getCtx(),b=rt(t),_=t.layout.contentX-t.renderStyles.paddingLeft-y,T=t.layout.contentY-t.renderStyles.paddingTop-v,S=r+s+h+(y+m),w=o+c+u+(v+x);console.log(_,T,S,w,i),l(g)&&(C.globalAlpha=g),a&&d&&this._restore((function(){e._path((function(){e.topBorder({x:_,y:T,borderRadius:b,w:S,h:w}),e.rightBorder({x:_,y:T,borderRadius:b,w:S,h:w}),e.bottomBorder({x:_,y:T,borderRadius:b,w:S,h:w}),e.leftBorder({x:_,y:T,borderRadius:b,w:S,h:w})})),l(f)&&(e.getCtx().shadowOffsetX=f),l(p)&&(e.getCtx().shadowOffsetY=p),e.getCtx().shadowBlur=d,e.getCtx().shadowColor=a,e.getCtx().fillStyle=a,e.getCtx().fill()})),this._clip(t),i&&(this.getCtx().fillStyle=this._parseBackground(i,t),this.getCtx().fillRect(t.layout.contentX-s+t.styles.marginLeft,t.layout.contentY-c+t.styles.marginTop,r+s+h,o+c+u)),this.isDebug()&&(this.getCtx().strokeStyle=t.debugColor||"green",this.getCtx().strokeRect(t.layout.contentX,t.layout.contentY,t.renderStyles.contentWidth,t.renderStyles.contentHeight))}},_clip:function(t){var e=this;if("hidden"===t.renderStyles.overflow){var n=t.renderStyles,i=n.contentWidth,r=n.contentHeight,o=n.paddingLeft,a=n.paddingTop,d=n.paddingRight,l=n.paddingBottom,s=n.borderLeftWidth,h=n.borderRightWidth,c=n.borderTopWidth,u=n.borderBottomWidth,g=rt(t),f=.7,p=t.contentX-t.renderStyles.paddingLeft-s*f,y=t.contentY-t.renderStyles.paddingTop-c*f,m=i+o+d+(s+h)*f,v=r+a+l+(c+u)*f;this._path((function(){e.topBorder({x:p,y:y,borderRadius:g,w:m,h:v}),e.rightBorder({x:p,y:y,borderRadius:g,w:m,h:v}),e.bottomBorder({x:p,y:y,borderRadius:g,w:m,h:v}),e.leftBorder({x:p,y:y,borderRadius:g,w:m,h:v})})),this.getCtx().clip()}},_parseBackground:function(t,e){if(Array.isArray(t)){for(var n=this.getCtx().createLinearGradient(e.contentX,e.contentY,e.contentX+e.renderStyles.contentWidth,e.contentY+e.renderStyles.contentHeight),i=0;i<t.length;i++)0===i?n.addColorStop(0,t[0]):n.addColorStop(i/(t.length-1),t[i]);return n}return t},_drawText:function(t){var e=this,n=t.renderStyles,i=n.color,r=n.contentWidth,o=n.lineHeight,a=n.textAlign,d=n.textIndent,l=n.textDecoration,s=t.contentX;this.getCtx().fillStyle=i,this.getCtx().textAlign=a,this.getCtx().font=t._getFont(),this.getCtx().textBaseline="middle",a===K.TEXT_ALIGN.RIGHT?s=t.contentX+r:a===K.TEXT_ALIGN.CENTER&&(s=t.contentX+r/2);for(var h,c=s,u=0,g=function(n){if(h=t.lines[n],c=0===n&&d?s+d:s,u=t.contentY+o/2+o*n+.5,f.getCtx().fillText(h.text,c,u),v&&400!==t.renderStyles.fontWeight){var r=.001*t.renderStyles.fontSize;f.getCtx().fillText(h.text,c-r,u)}if(l){var a=l[0];u+=1,f._restore((function(){e._path((function(){var n=u;"underline"===a?n=u+t._layout.fontHeight/2:"line-through"===a&&(n=u),e.getCtx().moveTo(c,n),e.getCtx().lineTo(c+h.layout.width,n)})),e.getCtx().strokeStyle=i,e.getCtx().stroke()}))}},f=this,p=0;p<t.lines.length;p++)g(p)},_drawImage:function(t){if(t._image){var e=t.renderStyles,n=e.contentWidth,i=e.contentHeight,r=t.options.attrs.mode,o=t._imageInfo,a=o.sx,d=o.sy,l=o.swidth,s=o.sheight,h=o.dx,c=o.dy,u=o.dwidth,g=o.dheight,f=o.width,p=o.height;"aspectFill"===r?this.getCtx().drawImage(t._image,a,d,l,s,t.contentX,t.contentY,n,i):"aspectFit"===r?this.getCtx().drawImage(t._image,0,0,f,p,h,c,u,g):this.getCtx().drawImage(t._image,t.contentX,t.contentY,n,i)}},_drawScroll:function(t){this.getCtx().translate(t.currentScrollX,t.currentScrollY)},_animate:function(){var t=this,e=Date.now();this.render(this.element),this.isAnimate&&window.requestAnimationFrame((function(){return t._animate(e)}))},isDebug:function(){return this.getLayer().options.debug},getCtx:function(){return this.layer.ctx},getLayer:function(){return this.layer},paint:function(t){this.getCtx().save(),t.paint(this.lastPaintTime),this.afterPaint(t)},afterPaint:function(t){t.hasChildren()&&"text"!==t.type||this.getCtx().restore(),this._helpParentRestoreCtx(t)},topBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,r=t.w;t.h,this.getCtx().moveTo(e,n+i),i&&this.getCtx().arc(e+i,n+i,i,2*angle,3*angle),this.getCtx().lineTo(e+r-i,n)},rightBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,r=t.w,o=t.h;i&&this.getCtx().arc(e+r-i,n+i,i,3*angle,4*angle),this.getCtx().lineTo(e+r,n+o-i)},bottomBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,r=t.w,o=t.h;i&&this.getCtx().arc(e+r-i,n+o-i,i,0,angle),this.getCtx().lineTo(e+i,n+o)},leftBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius;t.w;var r=t.h;i&&this.getCtx().arc(e+i,n+r-i,i,angle,2*angle),this.getCtx().lineTo(e,n+i)},measureText:function(t,e){var n=this,i=0,r=0;return this._restore((function(){n.getCtx().font=t._getFont();var o=n.getCtx().measureText(e),a=o.width,d=o.actualBoundingBoxAscent;i=a,r=d||.7*t.renderStyles.fontSize})),{width:i,fontHeight:r+1}},getImageInstance:function(t){var e,n,i=this,r=null;return this.imageBus[t]?r=this.imageBus[t]:(v?this.getCanvas()?r=this.getCanvas().createImage():(console.warn("小程序请使用设置canvas参数以创建图片"),e=t,n={onload:function(){}},new Promise((function(t,n){wx.downloadFile({url:e,success:function(e){wx.getImageInfo({src:e.tempFilePath,success:function(n){t({target:{width:n.width,height:n.height},image:e.tempFilePath})}})},fail:function(t){n(t)}})})).then((function(t){n.onload(t)})).catch((function(t){})),r=n):(r=new Image).crossOrigin="anonymous",t&&(this.imageBus[t]=new Promise((function(t,e){r.onload=function(e){t({image:v&&!i.getCanvas()?e.image:r,info:{width:v?r.width:e.target.width,height:v?r.height:e.target.height}})},r.onerror=function(t){e(t)}}))),r.src=t),this.imageBus[t]},render:function(t){var e=this;console.log("render",t),this.lastFrameComplete=!1,this.lastPaintTime=Date.now(),t.parent?this.getCtx().clearRect(t.layout.x,t.layout.y,t.renderStyles.width,t.renderStyles.height):this.getCtx().clearRect(0,0,this.getLayer().options.width,this.getLayer().options.height),function(t,e){var n=!1,i=!1,r=function(){return n=!0},o=function(){return i=!0};if(console.log("walk-0000",t.children),null!=t){var a=[],d=void 0,l=void 0;for(a.push(t);0!==a.length&&(d=a.pop());)if(e(d,r,o),!i&&d){if(l=d.children,console.log("13132145332",l,l.length),u(l))for(var s=l.length-1;s>=0;s--)n?n=!1:a.push(l[s])}else i=!1}}(t,(function(t,n,i){var r;console.log("walk",t),(r=t)&&!0===r.__v_isCanvasElement&&t.isVisible()?(e.paint(t),console.log("paint",t)):(i(),e._helpParentRestoreCtx(t))})),v&&this.getCtx().draw&&this.getCtx().draw(),this.lastFrameComplete=!0},renderFPS:function(){},readyToRender:function(t){this.element=t;var e=this.getLayer().options;this.lastPaintTime=Date.now(),e&&e.animate?this.animate():this.render(t)},requestRepaint:function(t){this.isAnimate||this.render(this.element)},getCanvas:function(){var t=this.getLayer().options;return t&&t.canvas||null},stopAnimate:function(){this.isAnimate=!1},onEffectFinished:function(){var t=this,e=Object.keys(this.imageBus).map((function(e){return t.imageBus[e]}));return Promise.all(e)}};return i}var at={createNodeOps:function(t){return{insert:function(t,e,n){t&&e.appendChild(t)},remove:function(t){},createElement:function(e,n){var i=(n=n||{}).style;return t("view",{style:i})},createText:function(e){return t("text",{},e)},createComment:function(t){},setText:function(t,e){},setElementText:function(t,e){},parentNode:function(t){return t.parentNode},nextSibling:function(t){return t.nextSibling}}},createRenderer:function(t){var r=t.insert,o=t.remove,a=t.patchProp,d=t.createElement,l=t.createText;t.createComment;var s=t.setText,h=t.setElementText;t.parentNode;var c=t.nextSibling,u=function(t,e,n,i,r){if(void 0===i&&(i=null),void 0===r&&(r=null),t!==e)if(t&&!function(t,e){return t.type===e.type}(t,e)&&(i=S(t),b(t,r,!0),t=null),"Text"===e.type)g(t,e,n,i);else f(t,e,n,i,r)},g=function(t,e,n,i){null==t?r(l(e.children),n,i):e.children!==t.children&&s(e,e.children)},f=function(t,e,n,i,r){null==t?p(e,n,i,r):m(t,e,r)},p=function(t,e,n,i){var o;t.type;var a=t.props;o=t.el=d(t.type,a),y(t.children,o,null,i),r(o,e,n)},y=function(t,e,n,i,r){if(void 0===r&&(r=0),"string"==typeof t)u(null,O(t),e,n,i);else for(var o=r;o<t.length;o++){var a=O(t[o]);u(null,a,e,n,i)}},m=function(t,e,i){var r=e.el=t.el,o=t.props||n,a=e.props||n;v(t,e,r,null,i),t.children!==e.children&&h(r,e.children),C(r,e,o,a,i)},v=function(t,e,n,i,r){var o=t&&t.children,a=e.children;x(o,a,n,i,r)},x=function(t,e,n,r,o){e=e||i;var a,d=(t=t||i).length,l=e.length,s=Math.min(d,l);for(a=0;a<s;a++){var h=O(e[a]);u(t[a],h,n,null,o)}d>l?T(t,o,!0,!1,s):y(e,n,r,o,s)},C=function(t,e,i,r,o){if(i!==r){if(i!==n)for(var d in i)a(t,d,i[d],null,e.children,o,T);for(var d in r){var l=r[d],s=i[d];l!==s&&"value"!==d&&a(t,d,s,l,e.children,o,T)}"value"in r&&a(t,"value",i.value,r.value)}},b=function(t,e,n,i){void 0===n&&(n=!1),t.type,t.props;var r=t.children;T(r,e),n&&_(t)},_=function(t){o(t)},T=function(t,e,n,i,r){void 0===n&&(n=!1),void 0===r&&(r=0);for(var o=r;o<t.length;o++)b(t[o],e,n)},S=function(t){return c(t)},w=function(t,n){null==t?n._vnode&&b(n._vnode,null,!0):u(n._vnode||null,t,n,null,null),function(t,e){for(void 0===e&&(e=0),t=t||new Map;e<D.length;e++){var n=D[e];if(n&&n.pre){if(U(t,n))continue;D.splice(e,1),e--,n()}}}(),function(t){if(H.length){var n=e([],new Set(H),!0);if(H.length=0,F)return void F.push.apply(F,n);for(F=n,t=t||new Map,F.sort((function(t,e){return k(t)-k(e)})),Y=0;Y<F.length;Y++)U(t,F[Y])||F[Y]();F=null,Y=0}}(),n._vnode=t};return{render:w,createApp:N(w)}},h:function(t,e,n){var i=arguments.length;return 2===i?y(e)&&!u(e)?W(e)?B(t,null,[e]):B(t,e):B(t,null,e):(i>3?n=Array.prototype.slice.call(arguments,2):3===i&&W(n)&&(n=[n]),B(t,e,n))},createLayer:function(t,e){var n={ctx:t,node:null,p2cList:[],c2pList:[],nodeList:[],options:e,renderer:null,_initRender:function(){var t=Date.now();z(n.node),n._initC2PList(),n._initP2CList(),n._flow(),n.renderer.onEffectFinished().then((function(t){return n.lifecycle("onEffectSuccess",t)})).catch((function(t){return n.lifecycle("onEffectFail",t)})),n._repaint(),console.log("渲染".concat(n.p2cList.length,"个元素 耗时 ").concat(Date.now()-t," ms"))},_initP2CList:function(){n.node&&(n.p2cList=it(n.node))},_initC2PList:function(){n.node&&(n.c2pList=function(t){var e=[];if(null!=t){var n=[],i=void 0,r=void 0;for(n.unshift(t);0!=n.length;)if(i=n.shift(),e.push(i),r=i.children,u(r))for(var o=r.length-1;o>=0;o--)n.push(r[o])}return e}(n.node))},_flow:function(){for(var t=0;t<n.p2cList.length;t++)n.p2cList[t].initRenderStyles();n._reflow()},_reflow:function(){},_initPaintList:function(){},_reflowElement:function(t){for(var e=t;e&&e.line;)e=e.container;for(var n=it(e),i=0;i<n.length;i++)n[i].initRenderStyles();this.onElementChange(e)},_callBeforePaint:function(){for(var t=0;t<n.p2cList.length;t++)n.p2cList[t].beforePaint&&n.p2cList[t].beforePaint()},_repaint:function(t){if(void 0===t&&(t=n.node),v&&(t=n.node),!n.node||!n.renderer)throw Error("repaint need node in layer");n.renderer.readyToRender(n.node)},update:function(t,e){n.ctx=t,n.options=e,n.options.renderStyles=e},init:function(){n.renderer=ot(n),n._initRender()},mount:function(t){n.node.appendChild(t)},onElementRemove:function(){},onElementAdd:function(t){n._initC2PList(),n._initP2CList(),n.p2cList.forEach((function(t){t.initRenderStyles()})),n._reflowElement(t)},onElementChange:function(t){n._repaint()},animate:function(){console.warn("use [animate] option instead!")},getElementBy:function(){var t;return(t=n.node).getElementBy.apply(t,arguments)},lifecycle:function(t,e){n.options.lifecycle&&n.options.lifecycle[t]&&n.options.lifecycle[t](e)}},i=Z(n),r=function(){return i("root",{},[])};return n.node=r(),n.node.layer=n,n.node.root=n.node,n.init(),{layer:n,createCanvasElement:i,createRootCanvasElement:r}}};return at}));
//# sourceMappingURL=x-canvas.js.map
