!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).XCanvas=e()}(this,function(){"use strict";function m(t){return.5+t<<0}function s(t,e){if(t)for(var n=t,i=!1,r=function(){i=!0};n.parent&&(e(n.parent,r),!i);)n=n.parent}function S(t){return"string"==typeof t&&t.match("%")}function x(t){return t=parseInt(t.replace("%","")),isNaN(t)||t<0?0:t/100}function l(t){return"function"==typeof t}var f=function(){try{return Boolean(wx.getSystemInfoSync)}catch(t){return!1}}(),v=Object.freeze({}),_=Object.freeze([]),N=/^on[^a-z]/,F=function(t){return N.test(t)},w=function(t){return"number"==typeof t},d=function(t){return"auto"===t},a=Array.isArray,h=function(t){return"string"==typeof t},g=function(t){return null!==t&&"object"==typeof t};function c(t){if(a(t)){for(var e={},n=0;n<t.length;n++){var i=t[n],r=(h(i)?function(t){var e={};return t.replace(D,"").split(k).forEach(function(t){t&&1<(t=t.split(O)).length&&(e[t[0].trim()]=t[1].trim())}),e}:c)(i);if(r)for(var o in r)e[o]=r[o]}return e}return h(t)||g(t)?t:void 0}var k=/;(?![^(]*\))/g,O=/:([^]+)/,D=/\/\*.*?\*\//gs;function y(t){var e="";if(h(t))e=t;else if(a(t))for(var n=0;n<t.length;n++){var i=y(t[n]);i&&(e+=i+" ")}else if(g(t))for(var r in t)t[r]&&(e+=r+" ");return e.trim()}var Y=Symbol.for("v-fgt"),U=Symbol.for("v-cmt");function u(t){return t&&!0===t.__v_isVNode}function p(t,e,n){var i,r,o;return void 0===e&&(e=null),void 0===n&&(n=null),console.log("createVNode",t,e,n),u(t)?(o=L(t,e),console.log("cloned",o),n&&(i=o,r=n,console.log("normalizeChildren",i,r),null==r?r=null:a(r)||"object"==typeof r||l(r)||(r=[C(r)]),i.children=r),console.log("children",n),o):(e&&(i=e.class,r=e.style,i&&!h(i)&&(e.class=y(i)),g(r))&&(e.style=c(r)),o=t,void 0===(t=e)&&(t=null),void 0===(e=n)&&(e=null),console.log("createBaseVNode",o,t,e),{__v_isVNode:!0,__v_skip:!0,type:o,props:t,children:e,component:null,el:null,staticCount:0,appContext:null,ctx:null})}function L(t,e){var n,i;return t&&"object"!=typeof t?(console.log("cloneVNode",t),t):(n=t.props,i=t.children,e=e?function(){for(var t=arguments,e=[],n=0;n<arguments.length;n++)e[n]=t[n];for(var i={},r=0;r<e.length;r++){var o,s,l,d=e[r];for(o in d)"class"===o?i.class!==d.class&&(i.class=y([i.class,d.class])):"style"===o?i.style=c([i.style,d.style]):F(o)?(s=i[o],!(l=d[o])||s===l||a(s)&&s.includes(l)||(i[o]=s?[].concat(s,l):l)):""!==o&&(i[o]=d[o])}return i}(n||{},e):n,{__v_isVNode:!0,type:t.type,props:e,children:a(i)?i.map(r):i,staticCount:t.staticCount,appContext:t.appContext,component:t.component,el:t.el,ctx:t.ctx})}function r(t){console.log("deepCloneVNode",t);var e=L(t);return a(t.children)&&(e.children=t.children.map(r)),e}function C(t){return p("Text",null,t=void 0===t?" ":t)}function b(t){return console.log("normalizeVNode",t),null==t||"boolean"==typeof t?p(U):a(t)?p(Y,null,t.slice()):"object"==typeof t?L(t):C(String(t))}var T=function(){return(T=Object.assign||function(t){for(var e,n=arguments,i=1,r=arguments.length;i<r;i++)for(var o in e=n[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};var W=[],n=[],i=null,o=0,V=100;function j(t){if(n.length){var e=function(t,e,n){if(n||2===arguments.length)for(var i,r=0,o=e.length;r<o;r++)!i&&r in e||((i=i||Array.prototype.slice.call(e,0,r))[r]=e[r]);return t.concat(i||Array.prototype.slice.call(e))}([],new Set(n),!0);if(n.length=0,i)i.push.apply(i,e);else{for(i=e,t=t||new Map,i.sort(function(t,e){return B(t)-B(e)}),o=0;o<i.length;o++)I(t,i[o])||i[o]();i=null,o=0}}}function B(t){return null==t.id?1/0:t.id}function I(t,e){if(t.has(e)){var n=t.get(e);if(V<n)return 1;t.set(e,n+1)}else t.set(e,1)}function z(t){var d=t.insert,e=t.remove,a=t.patchProp,h=t.createElement,r=t.createText,o=(t.createComment,t.setText),g=t.setElementText,n=(t.parentNode,t.nextSibling),c=function(t,e,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),t!==e&&(t&&t.type!==e.type&&(i=x(t),p(t,r,!0),t=null),"Text"===e.type?s(t,e,n,i):l(t,e,n,i,r))},s=function(t,e,n,i){null==t?d(r(e.children),n,i):e.children!==t.children&&o(e,e.children)},l=function(t,e,n,i,r){if(null==t)n=n,i=i,s=r,(o=e).type,l=o.props,l=o.el=h(o.type,l),y(o.children,l,null,s),d(l,n,i);else{o=t,s=e,l=r,n=s.el=o.el,i=o.props||v,t=s.props||v;if(u(o,s,n,null,l),o.children!==s.children)g(n,s.children);f(n,s,i,t,l)}var o,s,l},y=function(t,e,n,i,r){if(void 0===r&&(r=0),"string"==typeof t)c(null,b(t),e,n,i);else for(var o=r;o<t.length;o++){var s=b(t[o]);c(null,s,e,n,i)}},u=function(t,e,n,i,r){for(var t=t&&t.children,e=e.children,o=t,s=e,l=n,t=i,d=r,e=(o=o||_).length,n=(s=s||_).length,a=Math.min(e,n),h=0;h<a;h++){var g=b(s[h]);c(o[h],g,l,null,d)}n<e?S(o,d,!0,!1,a):y(s,l,t,d,a)},f=function(t,e,n,i,r){if(n!==i){if(n!==v)for(var o in n)a(t,o,n[o],null,e.children,r,S);for(var o in i){var s=i[o],l=n[o];s!==l&&"value"!==o&&a(t,o,l,s,e.children,r,S)}"value"in i&&a(t,"value",n.value,i.value)}},p=function(t,e,n,i){void 0===n&&(n=!1),t.type,t.props;var r=t.children;S(r,e),n&&m(t)},m=function(t){e(t)},S=function(t,e,n,i,r){void 0===n&&(n=!1);for(var o=r=void 0===r?0:r;o<t.length;o++)p(t[o],e,n)},x=function(t){return n(t)};return{render:function(t,e){null==t?e._vnode&&p(e._vnode,null,!0):c(e._vnode||null,t,e,null,null);var n=void 0,i=void 0;for(void 0===i&&(i=0),n=n||new Map;i<W.length;i++){var r=W[i];r&&r.pre&&(I(n,r)||(W.splice(i,1),i--,r()))}j(),e._vnode=t}}}function R(t){return t&&!0===t.__v_isTreeNode}var t={BLOCK:"block",INLINE_BLOCK:"inline-block",INLINE:"inline",FLEX:"flex",NONE:"none"},e={AUTO:"auto",OUTER:"100%"},E={ROW:"row",COLUMN:"column"},A={DISPLAY:t,WIDTH:e,POSITION:{ABSOLUTE:"absolute",FIXED:"fixed",RELATIVE:"relative",STATIC:"static"},TEXT_ALIGN:{LEFT:"left",RIGHT:"right",CENTER:"center"},FLEX_DIRECTION:E,DEFAULT_STYLES:{display:t.BLOCK,fontSize:14,fontWeight:400,fontFamily:"sans-serif",color:"#000",paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginTop:0,marginBottom:0,marginLeft:0,marginRight:0,height:e.AUTO,borderRadius:0,lineCap:"square",flexDirection:E.ROW,verticalAlign:"middle",textAlign:"left",justifyContent:"flex-start",alignItems:"flex-start",alignSelf:"auto",whiteSpace:"normal",zIndex:1,visible:!0,position:"static"}};function P(t){var e=t.renderStyles,n=e.paddingWidth,e=e.paddingHeight,t=t.renderStyles.borderRadius;return m(t=(t=e<2*(t=n<2*t?n/2:t)?e/2:t)<0?0:t)}function K(t){var e,n;return{layer:t,imageBus:{},isAnimate:!1,lastPaintTime:0,lastFrameComplete:!1,throttle:(e=16,function(t){n=n||setTimeout(function(){t(),n=null},e)}),_restore:function(t){this.getCtx().save(),t(),this.getCtx().restore()},_path:function(t){this.getCtx().beginPath(),t(),this.getCtx().closePath()},_helpParentRestoreCtx:function(t){if(!(t.isVisible()&&(!(e=t).parent||e.next||e.hasChildren())||!t.isVisible()&&t.next)){this.getCtx().restore();for(var e,n=t.parent;n&&!n.next;)this.getCtx().restore(),n=n.parent}},_drawBox:function(t){var e,n,i,r,o,s,l,d,a,h,g,c,y,u,f,p,m,S,x,v=this;(t.renderStyles.borderColor||t.renderStyles.shadowBlur)&&(n=(e=t.renderStyles).contentWidth,i=e.contentHeight,r=e.paddingLeft,o=e.paddingTop,s=e.borderStyle,l=e.paddingRight,d=e.paddingBottom,a=e.borderLeftWidth,h=e.borderRightWidth,g=e.borderTopWidth,c=e.borderBottomWidth,y=e.borderWidth,u=P(t),f=t.contentX-t.renderStyles.paddingLeft-a/2,p=t.contentY-t.renderStyles.paddingTop-g/2,m=n+r+l+(a+h)/2,S=i+o+d+(g+c)/2,this.getCtx().lineCap=t.renderStyles.lineCap,this.getCtx().strokeStyle=t.renderStyles.borderColor,this.getCtx().lineJoin="round",s&&"solid"!==s&&(Array.isArray(s)?this.getCtx().setLineDash(s):this.getCtx().setLineDash([5,5])),x=function(t){v.getCtx().lineWidth=t,v.getCtx().stroke()},this._restore(function(){v._path(function(){t.renderStyles.borderTopWidth&&(v.topBorder({x:f,y:p,borderRadius:u?u+t.renderStyles.borderTopWidth/2:0,w:m,h:S}),y||x(t.renderStyles.borderTopWidth)),t.renderStyles.borderRightWidth&&(v.getCtx().moveTo(f+m-u-(u?t.renderStyles.borderTopWidth/2:0),p),v.rightBorder({x:f,y:p,borderRadius:u?u+t.renderStyles.borderRightWidth/2:0,w:m,h:S}),y||x(t.renderStyles.borderRightWidth)),t.renderStyles.borderBottomWidth&&(v.getCtx().moveTo(f+m,p+S-u-(u?t.renderStyles.borderRightWidth/2:0)),v.bottomBorder({x:f,y:p,borderRadius:u?u+t.renderStyles.borderBottomWidth/2:0,w:m,h:S}),y||x(t.renderStyles.borderBottomWidth)),t.renderStyles.borderLeftWidth&&(v.getCtx().moveTo(f+u+(u?t.renderStyles.borderBottomWidth/2:0),p+S),v.leftBorder({x:f,y:p,borderRadius:u?u+t.renderStyles.borderLeftWidth/2:0,w:m,h:S}),x(t.renderStyles.borderLeftWidth))})}))},_drawBackground:function(t){var e=this,n=t.renderStyles,i=n.backgroundColor,r=n.contentWidth,o=n.contentHeight,s=n.shadowColor,l=n.shadowBlur,d=n.paddingLeft,a=n.paddingRight,h=n.paddingTop,g=n.paddingBottom,c=n.opacity,y=n.shadowOffsetX,u=n.shadowOffsetY,f=n.borderLeftWidth,p=n.borderRightWidth,m=n.borderTopWidth,n=n.borderBottomWidth,S=this.getCtx(),x=P(t),v=t.contentX-t.renderStyles.paddingLeft-f,_=t.contentY-t.renderStyles.paddingTop-m,L=r+d+a+(f+p),C=o+h+g+(m+n);w(c)&&(S.globalAlpha=c),s&&l&&this._restore(function(){e._path(function(){e.topBorder({x:v,y:_,borderRadius:x,w:L,h:C}),e.rightBorder({x:v,y:_,borderRadius:x,w:L,h:C}),e.bottomBorder({x:v,y:_,borderRadius:x,w:L,h:C}),e.leftBorder({x:v,y:_,borderRadius:x,w:L,h:C})}),w(y)&&(e.getCtx().shadowOffsetX=y),w(u)&&(e.getCtx().shadowOffsetY=u),e.getCtx().shadowBlur=l,e.getCtx().shadowColor=s,e.getCtx().fillStyle=s,e.getCtx().fill()}),this._clip(t),i&&(this.getCtx().fillStyle=this._parseBackground(i,t),this.getCtx().fillRect(t.contentX-d,t.contentY-h,r+d+a,o+h+g)),this.isDebug()&&(this.getCtx().strokeStyle=t.debugColor||"green",this.getCtx().strokeRect(t.contentX,t.contentY,t.renderStyles.contentWidth,t.renderStyles.contentHeight))},_clip:function(t){var e,n,i,r,o,s,l,d,a,h,g,c,y,u,f,p=this;"hidden"===t.renderStyles.overflow&&(e=(h=t.renderStyles).contentWidth,n=h.contentHeight,i=h.paddingLeft,r=h.paddingTop,o=h.paddingRight,s=h.paddingBottom,l=h.borderLeftWidth,d=h.borderRightWidth,a=h.borderTopWidth,h=h.borderBottomWidth,g=P(t),c=t.contentX-t.renderStyles.paddingLeft-.7*l,y=t.contentY-t.renderStyles.paddingTop-.7*a,u=e+i+o+.7*(l+d),f=n+r+s+.7*(a+h),this._path(function(){p.topBorder({x:c,y:y,borderRadius:g,w:u,h:f}),p.rightBorder({x:c,y:y,borderRadius:g,w:u,h:f}),p.bottomBorder({x:c,y:y,borderRadius:g,w:u,h:f}),p.leftBorder({x:c,y:y,borderRadius:g,w:u,h:f})}),this.getCtx().clip())},_parseBackground:function(t,e){if(Array.isArray(t)){for(var n=this.getCtx().createLinearGradient(e.contentX,e.contentY,e.contentX+e.renderStyles.contentWidth,e.contentY+e.renderStyles.contentHeight),i=0;i<t.length;i++)0===i?n.addColorStop(0,t[0]):n.addColorStop(i/(t.length-1),t[i]);return n}return t},_drawText:function(n){for(var i,r=this,t=n.renderStyles,o=t.color,e=t.contentWidth,s=t.lineHeight,l=t.textAlign,d=t.textIndent,a=t.textDecoration,h=n.contentX,g=(this.getCtx().fillStyle=o,this.getCtx().textAlign=l,this.getCtx().font=n._getFont(),this.getCtx().textBaseline="middle",l===A.TEXT_ALIGN.RIGHT?h=n.contentX+e:l===A.TEXT_ALIGN.CENTER&&(h=n.contentX+e/2),h),c=0,y=this,u=0;u<n._lines.length;u++)!function(t){var e;i=n._lines[t],g=0===t&&d?h+d:h,c=n.contentY+s/2+s*t+.5,y.getCtx().fillText(i.text,g,c),f&&400!==n.renderStyles.fontWeight&&(t=.001*n.renderStyles.fontSize,y.getCtx().fillText(i.text,g-t,c)),a&&(e=a[0],c+=1,y._restore(function(){r._path(function(){var t=c;"underline"===e?t=c+n._layout.fontHeight/2:"line-through"===e&&(t=c),r.getCtx().moveTo(g,t),r.getCtx().lineTo(g+i.layout.width,t)}),r.getCtx().strokeStyle=o,r.getCtx().stroke()}))}(u)},_drawImage:function(t){var e,n,i,r,o,s,l,d,a,h,g,c,y;t._image&&(e=(n=t.renderStyles).contentWidth,n=n.contentHeight,i=t.options.attrs.mode,r=(y=t._imageInfo).sx,o=y.sy,s=y.swidth,l=y.sheight,d=y.dx,a=y.dy,h=y.dwidth,g=y.dheight,c=y.width,y=y.height,"aspectFill"===i?this.getCtx().drawImage(t._image,r,o,s,l,t.contentX,t.contentY,e,n):"aspectFit"===i?this.getCtx().drawImage(t._image,0,0,c,y,d,a,h,g):this.getCtx().drawImage(t._image,t.contentX,t.contentY,e,n))},_drawScroll:function(t){this.getCtx().translate(t.currentScrollX,t.currentScrollY)},_animate:function(){var t=this,e=Date.now();this.render(this.element),this.isAnimate&&window.requestAnimationFrame(function(){return t._animate(e)})},isDebug:function(){return this.getLayer().options&&this.getLayer().options.debug},getCtx:function(){return this.layer.ctx},getLayer:function(){return this.layer},paint:function(t){this.getCtx().save(),t.paint(this.lastPaintTime),this.afterPaint(t)},afterPaint:function(t){t.hasChildren()&&"text"!==t.type||this.getCtx().restore(),this._helpParentRestoreCtx(t)},topBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,r=t.w;t.h,this.getCtx().moveTo(e,n+i),i&&this.getCtx().arc(e+i,n+i,i,2*angle,3*angle),this.getCtx().lineTo(e+r-i,n)},rightBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,r=t.w,t=t.h;i&&this.getCtx().arc(e+r-i,n+i,i,3*angle,4*angle),this.getCtx().lineTo(e+r,n+t-i)},bottomBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,r=t.w,t=t.h;i&&this.getCtx().arc(e+r-i,n+t-i,i,0,angle),this.getCtx().lineTo(e+i,n+t)},leftBorder:function(t){var e=t.x,n=t.y,i=t.borderRadius,t=(t.w,t.h);i&&this.getCtx().arc(e+i,n+t-i,i,angle,2*angle),this.getCtx().lineTo(e,n+i)},measureText:function(n,i){var r=this,o=0,s=0;return this._restore(function(){r.getCtx().font=n._getFont();var t=r.getCtx().measureText(i),e=t.width,t=t.actualBoundingBoxAscent;o=e,s=t||.7*n.renderStyles.fontSize}),{width:o,fontHeight:s+1}},getImageInstance:function(t){var i,e,r=this,o=null;return this.imageBus[t]?o=this.imageBus[t]:(f?o=this.getCanvas()?this.getCanvas().createImage():(console.warn("小程序请使用设置canvas参数以创建图片"),i=t,e={onload:function(){}},new Promise(function(n,e){wx.downloadFile({url:i,success:function(e){wx.getImageInfo({src:e.tempFilePath,success:function(t){n({target:{width:t.width,height:t.height},image:e.tempFilePath})}})},fail:function(t){e(t)}})}).then(function(t){e.onload(t)}).catch(function(t){}),e):(o=new Image).crossOrigin="anonymous",t&&(this.imageBus[t]=new Promise(function(e,n){o.onload=function(t){e({image:f&&!r.getCanvas()?t.image:o,info:{width:(f?o:t.target).width,height:(f?o:t.target).height}})},o.onerror=function(t){n(t)}})),o.src=t),this.imageBus[t]},render:function(t){var i=this,e=(this.lastFrameComplete=!1,this.lastPaintTime=Date.now(),t.parent?this.getCtx().clearRect(t.x,t.y,t.renderStyles.width,t.renderStyles.height):this.getCtx().clearRect(0,0,this.getLayer().options.width,this.getLayer().options.height),function(t,e,n){t.isVisible()?i.paint(t):(n(),i._helpParentRestoreCtx(t))});function n(){return o=!0}function r(){return s=!0}var o=!1,s=!1;if(null!=t){var l,d=[];for(d.push(t);0!==d.length;)if(e(l=d.pop(),n,r),!s&&l)for(var a,h=(a=l.treeNode.children).length-1;0<=h;h--)o?o=!1:d.push(a[h].context);else s=!1}f&&this.getCtx().draw&&this.getCtx().draw(),this.lastFrameComplete=!0},renderFPS:function(){},readyToRender:function(t){this.element=t;t=this.getLayer().options;this.lastPaintTime=Date.now(),t&&t.animate?this.animate():this.render(this.element)},requestRepaint:function(t){this.isAnimate||this.render(this.element)},getCanvas:function(){var t=this.getLayer().options;return t&&t.canvas||null},stopAnimate:function(){this.isAnimate=!1},onEffectFinished:function(){var e=this,t=Object.keys(this.imageBus).map(function(t){return e.imageBus[t]});return Promise.all(t)}}}function G(t){(e=t).parent&&e.parent.styles.display===A.DISPLAY.FLEX&&(e.styles.flex?"column"===e.parent.styles.flexDirection&&w(e.styles.flex)?e.styles.height=0:"row"===e.parent.styles.flexDirection&&w(e.styles.flex)&&(e.styles.width=0):w(e.styles.height)||w(e.styles.width)||(e.styles.flex=1));var e=t,e=(e.styles.width||(e.styles.display!==A.DISPLAY.INLINE_BLOCK&&e.styles.display!==A.DISPLAY.INLINE&&e.isInFlow()?e.styles.display===A.DISPLAY.BLOCK||e.styles.display===A.DISPLAY.FLEX?e.styles.width=A.WIDTH.OUTER:e.styles.width=0:e.styles.width=A.WIDTH.AUTO),S(e.styles.width)&&e.parent&&d(e.parent.styles.width)&&(e.styles.width=A.WIDTH.AUTO),S(e.styles.height)&&e.parent&&d(e.parent.styles.height)&&(e.styles.height=A.WIDTH.AUTO),t),n=(l=e.styles).borderWidth,i=l.borderLeftWidth,r=l.borderRightWidth,o=l.borderBottomWidth,s=l.borderTopWidth,l=l.borderRadius,r=(n||(e.styles.borderWidth=0,n=0),Array.isArray(n)?(e.styles.borderTopWidth=n[0],e.styles.borderRightWidth=n[1],e.styles.borderBottomWidth=n[2],e.styles.borderLeftWidth=n[3]):(i||(e.styles.borderLeftWidth=n),r||(e.styles.borderRightWidth=n),o||(e.styles.borderBottomWidth=n),s||(e.styles.borderTopWidth=n)),l&&(e.styles.overflow="hidden"),(i=t).styles.fontSize&&!i.styles.lineHeight&&(i.styles.lineHeight=1.4*i.styles.fontSize),t);r.styles.padding&&(w(r.styles.padding)?(r.styles.paddingLeft=r.styles.padding,r.styles.paddingBottom=r.styles.padding,r.styles.paddingRight=r.styles.padding,r.styles.paddingTop=r.styles.padding):Array.isArray(r.styles.padding)&&(2===r.styles.padding.length?(r.styles.paddingLeft=r.styles.paddingRight=r.styles.padding[1],r.styles.paddingBottom=r.styles.paddingTop=r.styles.padding[0]):4===r.styles.padding.length&&(r.styles.paddingLeft=r.styles.padding[3],r.styles.paddingBottom=r.styles.padding[2],r.styles.paddingRight=r.styles.padding[1],r.styles.paddingTop=r.styles.padding[0]))),w(r.styles.margin)?(r.styles.marginLeft=r.styles.margin,r.styles.marginBottom=r.styles.margin,r.styles.marginRight=r.styles.margin,r.styles.marginTop=r.styles.margin):Array.isArray(r.styles.margin)&&(2===r.styles.margin.length?(r.styles.marginLeft=r.styles.marginRight=r.styles.margin[1],r.styles.marginBottom=r.styles.marginTop=r.styles.margin[0]):4===r.styles.margin.length&&(r.styles.marginLeft=r.styles.margin[3],r.styles.marginBottom=r.styles.margin[2],r.styles.marginRight=r.styles.margin[1],r.styles.marginTop=r.styles.margin[0]))}var M=0;(t={})[A.FLEX_DIRECTION.ROW]={width:"width",contentWidth:"contentWidth",x:"x",y:"y",contentX:"contentX",height:"height",contentHeight:"contentHeight"},t[A.FLEX_DIRECTION.COLUMN]={width:"height",contentWidth:"contentHeight",x:"y",y:"x",contentX:"contentY",height:"width",contentHeight:"contentWidth"};var H,q=t;function X(t,e,n,i){void 0===e&&(e={}),console.log("createElement",t,e,n,i);var r,p={__v_isElement:!0,type:t,options:e,styles:{},renderStyles:{},debugColor:null,x:0,y:0,contentX:0,contentY:0,left:0,top:0,height:0,width:0,container:n,root:i?i.node:null,layer:i,get treeNode(){return o},_initStyles:function(){console.log("_initStyle",p),p.styles=Object.assign({},p._getDefaultStyles(),p._getParentStyles(),p.options.style||{}),console.log("_initStyles-00000000",p.styles),p._completeStyles(),p._initRenderStyles(),console.log("_initStyles",p.styles,p.renderStyles)},_initRenderStyles:function(){var e,t=T({},p.styles),n=p.getContainerLayout().contentWidth,i=p.getContainerLayout().contentHeight;d(t.width)?t.paddingWidth=0:S(t.width)?t.paddingWidth=x(t.width)*n-t.marginLeft-t.marginRight:t.paddingWidth=t.width,d(t.height)?t.paddingHeight=0:S(t.height)?t.paddingHeight=x(t.height)*i-t.marginTop-t.marginBottom:t.paddingHeight=t.height,t.paddingWidth||(t.paddingWidth=0),t.paddingHeight||(t.paddingHeight=0),t.contentWidth=t.paddingWidth-t.paddingLeft-t.paddingRight,t.contentHeight=t.paddingHeight-t.paddingTop-t.paddingBottom,t.width=t.paddingWidth+t.marginLeft+t.marginRight+p._getTotalBorderWidth(t),t.height=t.paddingHeight+t.marginTop+t.marginBottom+p._getTotalBorderHeight(t),p.renderStyles=t,p._InFlexBox()?p._bindFlexBox():p.isInFlow()||(p.relativeTo=(n=p).isInFlow()?n.parent:"fixed"===n.renderStyles.position?n.root:(e=null,s(n,function(t){"static"!==t.renderStyles.position&&(e=e||t)}),e=e||n.root))},_getParentStyles:function(t){void 0===t&&(t={alignSelf:"auto"});var e,n=p.parent&&p.parent.renderStyles||{},i=n.textAlign,r=n.fontSize,o=n.color,s=n.fontFamily,l=n.alignItems,n=n.visible,n=void 0===n||n;return console.log("_getParentStyles",p.parent),p.parent?(console.log("_getParentStyles-renderStyles",p.parent.renderStyles),e={},i&&(e.textAlign=i),r&&(e.fontSize=r),o&&(e.color=o),s&&(e.fontFamily=s),l&&!t.alignSelf&&(e.alignSelf=l),e.visible=n,e):{}},_getDefaultStyles:function(){return A.DEFAULT_STYLES},_completeStyles:function(){G(p)},_getChildrenInFlow:function(){return p._getChildren().filter(function(t){return t.isInFlow()})},_reflow:function(){},_initWidthHeight:function(){var t=p.styles,e=t.width,n=t.height,i=t.display;t.flex,t.marginLeft,t.marginRight,t.marginTop,t.marginBottom,(d(e)||d(n))&&(t=p._measureLayout(),d(e)&&(p.renderStyles.contentWidth=m(t.width)),d(n))&&(p.renderStyles.contentHeight=m(t.height)),p._refreshLayoutWithContent(),p._InFlexBox()?p.line.refreshWidthHeight(p):i===A.DISPLAY.INLINE_BLOCK&&p._bindLine()},_initPosition:function(){var t,e,n,i,r,o,s,l,d,a=p.getContainerLayout().contentX,h=p.renderStyles,g=h.paddingLeft,c=h.paddingTop,y=h.borderLeftWidth,u=h.borderTopWidth,f=h.marginLeft,h=h.marginTop;p.isInFlow()?p._InFlexBox()||p.renderStyles.display===A.DISPLAY.INLINE_BLOCK?p.line.refreshElementPosition(p):(p.x=a,p.y=p.getPrevLayout().y+p.getPrevLayout().height):(t=(a=p.getContainerLayout(p.relativeTo)).contentX,e=a.contentY,n=a.contentWidth,a=a.contentHeight,i=(d=p.renderStyles).top,r=d.bottom,o=d.right,s=d.left,l=d.width,d=d.height,S(i)&&(i=x(i)*a),S(r)&&(r=x(r)*a),S(s)&&(s=x(s)*n),S(o)&&(o=x(o)*n),w(i)?p.y=e+i:w(r)&&(p.y=e+a-r-d),w(s)?p.x=t+s:w(o)&&(p.x=t+n-o-l)),p.x=m(p.x),p.y=m(p.y),p.contentX=p.x+g+y+f,p.contentY=p.y+c+u+h},_InFlexBox:function(){return!!p.isInFlow()&&!!p.parent&&(!(!p.parent||p.parent.renderStyles.display!==A.DISPLAY.FLEX)||void 0)},_refreshLayoutWithContent:function(){p.renderStyles.height=m(p.renderStyles.contentHeight+p.renderStyles.paddingTop+p.renderStyles.paddingBottom+p.renderStyles.marginTop+p.renderStyles.marginBottom+p._getTotalBorderHeight()),p.renderStyles.width=m(p.renderStyles.contentWidth+p.renderStyles.paddingLeft+p.renderStyles.paddingRight+p.renderStyles.marginLeft+p.renderStyles.marginRight+p._getTotalBorderWidth()),p.renderStyles.paddingWidth=m(p.renderStyles.contentWidth+p.renderStyles.paddingLeft+p.renderStyles.paddingRight),p.renderStyles.paddingHeight=m(p.renderStyles.contentHeight+p.renderStyles.paddingTop+p.renderStyles.paddingBottom)},_refreshContentWithLayout:function(){p.renderStyles.contentHeight=p.renderStyles.height-p.renderStyles.paddingTop-p.renderStyles.paddingBottom-p.renderStyles.marginTop-p.renderStyles.marginBottom-p._getTotalBorderHeight(),p.renderStyles.contentWidth=p.renderStyles.width-p.renderStyles.paddingLeft-p.renderStyles.paddingRight-p.renderStyles.marginLeft-p.renderStyles.marginRight-p._getTotalBorderWidth(),p.renderStyles.paddingWidth=m(p.renderStyles.contentWidth+p.renderStyles.paddingLeft+p.renderStyles.paddingRight),p.renderStyles.paddingHeight=m(p.renderStyles.contentHeight+p.renderStyles.paddingTop+p.renderStyles.paddingBottom)},_getTotalBorderWidth:function(t){return(t=void 0===t?p.renderStyles:t).borderLeftWidth+t.borderRightWidth},_getTotalBorderHeight:function(t){return(t=void 0===t?p.renderStyles:t).borderTopWidth+t.borderBottomWidth},_bindLine:function(){var n;p.prev&&p.prev.line&&p.prev.line.canIEnter(p)?p.prev.line.add(p):(n={width:0,height:0,contentWidth:0,x:0,y:0,right:0,doorClosed:!1,outerWidth:0,container:null,elements:[],start:null,end:null,offsetX:0,id:++M,_initHeight:function(t){n.height=t.parent&&t.parent.context.renderStyles.lineHeight||0},_initLayout:function(t){n.right=t.getContainerLayout().contentX||0,n.x=t.getContainerLayout().contentX||0,n.y=n._getPrevLine(t).y},_getOffsetY:function(t){return"bottom"===t.renderStyles.verticalAlign?n.height-t.renderStyles.height:"middle"===t.renderStyles.verticalAlign?(n.height-t.renderStyles.height)/2:0},_refreshWidthHeight:function(t){t.renderStyles.height>n.height&&(n.height=t.renderStyles.height),n.width+=t.renderStyles.width},_closeLine:function(){n.end=n.elements[n.elements.length-1],n._refreshXAlign()},_getPrevLine:function(t){var e;return t.prev?(e=t.prev.context.line)?{y:e.height+e.y,x:e.x}:{y:(e=t.getPrevLayout()).y+e.height,x:e.x}:{y:t.getContainerLayout().contentY,x:t.getContainerLayout().contentX}},_refreshXAlign:function(){var t;5e3<n.outerWidth||n.end&&n.end.parent&&(t=n.outerWidth-n.width,"center"===n.end.parent.context.renderStyles.textAlign?t/=2:"left"===n.end.parent.context.renderStyles.textAlign&&(t=0),n.offsetX=t)},bindElement:function(t){var e;n.container=null==(e=t.parent)?void 0:e.context,n._initHeight(t),n.outerWidth=t.parent&&d(t.parent.context.styles.width)?1/0:null==(e=t.parent)?void 0:e.context.renderStyles.contentWidth,n.start=t,n.addElement(t)},refreshElementPosition:function(t){n.start===t&&n._initLayout(t),t.x=n.right+n.offsetX,t.y=n.y+n._getOffsetY(t),n.right+=t.renderStyles.width},addElement:function(t){n.elements.push(t),(t.line=n)._refreshWidthHeight(t),t.next&&"inline-block"===t.next.context.renderStyles.display||n._closeLine()},canIEnter:function(t){return!(t.renderStyles.width+n.width>n.outerWidth&&(n._closeLine(),1))}}).bindElement(p)},_bindFlexBox:function(){p.pre&&p.pre.line?p.pre.line.add(p):{key:null,exactValue:0,flexTotal:0,_closeLine:function(){_super.closeLine.call(this),this.calcFlex()},_initHeight:function(){this[this.key.height]=0},_refreshWidthHeight:function(t){t.renderStyles[this.key.height]>this[this.key.height]&&(this[this.key.height]=t.renderStyles[this.key.height]),this[this.key.width]+=t.renderStyles[this.key.width]},_initLayout:function(t){this.right=t.getContainerLayout()[this.key.contentX],this[this.key.x]=t.getContainerLayout()[this.key.contentX],this[this.key.y]=this.getPreLine(t)[this.key.y]},_refreshElementPosition:function(t){this.start===t&&this.initLayout(t),t[this.key.x]=this.right+this.offsetX,t[this.key.y]=this[this.key.y]+this.getOffsetY(t),this.right+=t.renderStyles[this.key.width]},_calcFlex:function(){var e=this,n=this.container.renderStyles[this.key.contentWidth];this.elements.forEach(function(t){w(t.styles.flex)&&(t.renderStyles[e.key.width]=t.styles.flex/e.flexTotal*(n-e.exactValue),t._refreshContentWithLayout())})},_refreshXAlign:function(){var t;this.end.parent&&(t=this.outerWidth-this[this.key.width],"center"===this.end.parent.renderStyles.justifyContent?t/=2:"flex-start"===this.end.parent.renderStyles.justifyContent&&(t=0),this.offsetX=t)},_getOffsetY:function(t){return"flex-end"===t.renderStyles.alignSelf?this.container.renderStyles[this.key.contentHeight]-t.renderStyles[this.key.height]:"center"===t.renderStyles.alignSelf?(this.container.renderStyles[this.key.contentHeight]-t.renderStyles[this.key.height])/2:0},bindElement:function(t){var e;this.container=t.parent,t.parent&&(this.key=q[t.parent.context.renderStyles.flexDirection]),this.initHeight(t),this.outerWidth=t.parent&&d(t.parent.context.styles[this.key.width])?1/0:null==(e=t.parent)?void 0:e.context.renderStyles[this.key.contentWidth],this.start=t,this.add(t)},addElement:function(t){w(t.styles[this.key.width])?this.exactValue+=t.renderStyles[this.key.width]:w(t.styles.flex)&&(this.flexTotal+=t.renderStyles.flex),this.elements.push(t),(t.line=this).refreshWidthHeight(t),t.next||this.closeLine()}}.bindElement(p)},_measureLayout:function(){var e=0,n=0;return p._getChildrenInFlow().forEach(function(t){t.line?t.line.start===t&&(t.line.width>e&&(e=t.line.width),n+=t.line.height):(t.renderStyles.width>e&&(e=t.renderStyles.width),n+=t.renderStyles.height)}),{width:e,height:n}},init:function(){console.log("init",p),p._initStyles()},mount:function(t){t.mountElement(p)},appendChild:function(t){o.appendChild.call(t,t),t.layer.onElementAdd(t)},getContainerLayout:function(t){return{width:(t=(t=void 0===t?p.parent:t)||{renderStyles:{width:p.container?p.container.width:"100%",height:p.container?p.container.height:"100%",paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginLeft:0,marginRight:0,marginTop:0,marginBottom:0,contentWidth:p.container?p.container.width:"100%",contentHeight:p.container?p.container.height:"100%"},x:0,y:0,contentX:0,contentY:0}).renderStyles.width,height:t.renderStyles.height,x:t.x,y:t.y,paddingTop:t.renderStyles.paddingTop,paddingBottom:t.renderStyles.paddingBottom,paddingLeft:t.renderStyles.paddingLeft,paddingRight:t.renderStyles.paddingRight,marginLeft:t.renderStyles.marginLeft,marginRight:t.renderStyles.marginRight,marginTop:t.renderStyles.marginTop,marginBottom:t.renderStyles.marginBottom,contentX:t.contentX,contentY:t.contentY,contentWidth:t.renderStyles.contentWidth,contentHeight:t.renderStyles.contentHeight}},getPrevLayout:function(){for(var t=p.pre;t&&!t.isInFlow();)t=t.pre;return t?{width:t.renderStyles.width,height:t.renderStyles.height,x:t.x,y:t.y}:{width:0,height:0,x:p.getContainerLayout().contentX,y:p.getContainerLayout().contentY}},isInFlow:function(){var t=p.styles,e=t.position;return t.display,e!==A.POSITION.ABSOLUTE&&e!==A.POSITION.FIXED},isVisible:function(){return p.renderStyles.visible&&p.visible},parseInt:function(t){}},o=r={__v_isTreeNode:!0,_children:[],parent:null,root:null,prev:null,next:null,context:p,get children(){return r.hasChildren()?r._children:[]},_setParent:function(t){console.log("_setParent",this,t),this.parent=r.parent=t,this.root=r.root=t.root},_setSibling:function(t,e){this.prev=r.prev=t,this.next=r.next=e},hasChildren:function(){return!(!Array.isArray(r._children)||!r._children.length)},appendChild:function(t){if(!R(t))throw Error("Unknown treeNode type");var e=this.children[this.children.length-1]||null;e&&e._setSibling(e.prev,t),this._children.push(t),t._setParent(this),t._setSibling(e,null)},prependChild:function(t){if(!R(t))throw Error("Unknown treeNode type")},removeChild:function(t){if(!R(t))throw Error("Unknown treeNode type")},append:function(){},prepend:function(){},remove:function(){}};return p.__proto__=o,p}(e=H=H||{}).root="root",e.view="view",e.text="text",e.img="img";var J=0;return{createApp:function(r,o){var s={_uid:J++,_component:r,_props:o=void 0===o?null:o,_container:null,_instance:null,mount:function(t,e){var n,i=p(r,o);s._container=t,e&&e.mountNode(t),z((n=e,{insert:function(t,e,n){console.log("insert",t,e,n),t&&e.appendChild(t)},remove:function(t){console.log("remove",t)},createElement:function(t,e){console.log("createElement",t,e);t=(e=e||{}).style;return X(H.view,{style:t},null,n)},createText:function(t){return X(H.text,{},null,n)},createComment:function(t){},setText:function(t,e){},setElementText:function(t,e){},parentNode:function(t){return t.parentNode},nextSibling:function(t){return t.nextSibling}})).render(i,t)}};return s},h:function(t,e,n){var i=arguments.length;return console.log("h",i,t,e,n),2===i?g(e)&&!a(e)?u(e)?p(t,null,[e]):p(t,e):p(t,null,e):(3<i?n=Array.prototype.slice.call(arguments,2):3===i&&u(n)&&(n=[n]),p(t,e,n))},createLayer:function(t,e){var n={ctx:t,node:null,p2cList:[],c2pList:[],nodeList:[],options:e,renderer:K(n),_initRender:function(){var t=Date.now();!function n(i){console.warn("connectChildren",i),i.hasChildren()&&(i.children=i.children.filter(function(t){R(t)}),i._getChildren().map(function(t,e){t._setParent(i),t._setSibling(i._getChildren()[e-1],i._getChildren()[e+1]),n(t)}))}(n.node),n._initC2PList(),n._initP2CList(),console.log("initRender",n.c2pList),n._flow(),n.renderer.onEffectFinished().then(function(t){return n.lifecycle("onEffectSuccess",t)}).catch(function(t){return n.lifecycle("onEffectFail",t)}),n._repaint(),console.log("渲染".concat(n.p2cList.length,"个元素 耗时 ").concat(Date.now()-t," ms"))},_initP2CList:function(){n.node&&(n.p2cList=function(t){var e=[];if(null!=t){var n,i=[];for(i.unshift(t);0!=i.length;){n=i.shift(),e.push(n.elementInstance);for(var r=n.children,o=0;o<r.length;o++)i.push(r[o].elementInstance)}}return e}(n.node))},_initC2PList:function(){n.node&&(n.c2pList=function(t){var e=[];if(null!=t){var n,i=[];for(i.unshift(t);0!=i.length;){n=i.shift(),e.push(n.elementInstance);for(var r,o=(r=n.children).length-1;0<=o;o--)i.push(r[o].elementInstance)}}return e}(n.node))},_flow:function(){for(var t=0;t<n.p2cList.length;t++)n.p2cList[t].init();n._reflow()},_reflow:function(){},_initPaintList:function(){},_reflowElement:function(t){},__callBeforePaint:function(){for(var t=0;t<n.p2cList.length;t++)n.p2cList[t].beforePaint&&n.p2cList[t].beforePaint()},_repaint:function(t){void 0===t&&(t=n.node),(t=f?n.node:t).isInFlow()||(t=n.node),n._callBeforePaint(),n.renderer.readyToRender(n.node)},update:function(t,e){n.ctx=t,n.options=e,n.options.renderStyles=e,n.node&&(n.node.context.container=n.options)},mountNode:function(t){console.info("mountNode------------------------",t),t.layer=n,t.root=t,n.node=t,n._initRender()},onElementRemove:function(){},onElementAdd:function(t){n._initC2PList(),n._initP2CList(),n.p2cList.forEach(function(t){t.init()}),n._reflowElement(t)},onElementChange:function(t){s(t,function(t,e){t._initWidthHeight(),"scroll-view"===t.type&&e()});for(var e=0;e<n.p2cList.length;e++)n.p2cList[e]._initPosition();n._repaint()},animate:function(){console.warn("use [animate] option instead!")},getElementBy:function(){var t;return(t=n.node).getElementBy.apply(t,arguments)},lifecycle:function(t,e){n.options.lifecycle&&n.options.lifecycle[t]&&n.options.lifecycle[t](e)}};return n},createElement:X}});
//# sourceMappingURL=x-canvas.js.map
